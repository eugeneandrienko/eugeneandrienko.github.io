<!DOCTYPE html>
<html lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Вторая жизнь для Thinkpad X220 | Dragon’s notes</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="Вторая жизнь для Thinkpad X220">
<meta name="author" content="Eugene Andrienko">
<meta property="og:locale" content="ru">
<meta name="description" content="Lenovo Thinkpad X220 — одна из обожаемых мною моделей ноутбуков (вторая из обожаемых — это Panasonic Toughbook CF-19). Прекрасная семирядная клавиатура, где нашлось место для всех необходимых кнопок — есть даже отдельные кнопки для Home, End, Pause1 и Insert! Прочный корпус из магниевого сплава, покрытый чем-то вроде резины для лучшей «хватабельности». Запоминающийся внешний вид — угловатый чёрный прямоугольник, который выглядит строго и в то же время достаточно ретро-футуристично. И сравнительно мощное железо, которым можно пользоваться и по сей день.">
<meta property="og:description" content="Lenovo Thinkpad X220 — одна из обожаемых мною моделей ноутбуков (вторая из обожаемых — это Panasonic Toughbook CF-19). Прекрасная семирядная клавиатура, где нашлось место для всех необходимых кнопок — есть даже отдельные кнопки для Home, End, Pause1 и Insert! Прочный корпус из магниевого сплава, покрытый чем-то вроде резины для лучшей «хватабельности». Запоминающийся внешний вид — угловатый чёрный прямоугольник, который выглядит строго и в то же время достаточно ретро-футуристично. И сравнительно мощное железо, которым можно пользоваться и по сей день.">
<link rel="canonical" href="https://eugene-andrienko.com/it/2024/07/07/thinkpad-x220-second-life.html">
<meta property="og:url" content="https://eugene-andrienko.com/it/2024/07/07/thinkpad-x220-second-life.html">
<meta property="og:site_name" content="Dragon’s notes">
<meta property="og:image" content="https://eugene-andrienko.com/assets/static/header-make-thinkpad-cool-again.jpg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-07-07T00:00:00+03:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://eugene-andrienko.com/assets/static/header-make-thinkpad-cool-again.jpg">
<meta property="twitter:title" content="Вторая жизнь для Thinkpad X220">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eugene Andrienko"},"dateModified":"2024-07-07T00:00:00+03:00","datePublished":"2024-07-07T00:00:00+03:00","description":"Lenovo Thinkpad X220 — одна из обожаемых мною моделей ноутбуков (вторая из обожаемых — это Panasonic Toughbook CF-19). Прекрасная семирядная клавиатура, где нашлось место для всех необходимых кнопок — есть даже отдельные кнопки для Home, End, Pause1 и Insert! Прочный корпус из магниевого сплава, покрытый чем-то вроде резины для лучшей «хватабельности». Запоминающийся внешний вид — угловатый чёрный прямоугольник, который выглядит строго и в то же время достаточно ретро-футуристично. И сравнительно мощное железо, которым можно пользоваться и по сей день.","headline":"Вторая жизнь для Thinkpad X220","image":"https://eugene-andrienko.com/assets/static/header-make-thinkpad-cool-again.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://eugene-andrienko.com/it/2024/07/07/thinkpad-x220-second-life.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://eugene-andrienko.com/assets/images/home.jpg"},"name":"Eugene Andrienko"},"url":"https://eugene-andrienko.com/it/2024/07/07/thinkpad-x220-second-life.html"}</script>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<link rel="me" href="https://mas.to/@evgandr">
<link rel="stylesheet" href="/assets/css/main.css">
<meta name="fediverse:creator" content="@evgandr@mas.to">
<link type="application/atom+xml" rel="alternate" href="https://eugene-andrienko.com/feed.xml" title="Dragon's notes">
</head>
<body>
<style>html .page-banner .page-banner-img>*:first-child{opacity:.6}</style>
<header class="site-header">
<div class="wrapper">
<div class="site-header-inner"><ul class="site-nav">
<li>
<a class="site-brand" rel="author" href="/">
Dragon's notes
</a>
</li>
<li>
<a class="page-link" href="/now.html">NOW</a>
</li>
<li>
<a class="page-link" href="/about.html">ABOUT</a>
</li>
<li>
<a class="page-link" href="/links.html">LINKS</a>
</li>

<li>
<a class="page-link" aria-label="RSS feed link" href="/feed.xml">
<span class="rss-text">RSS</span>
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
</a>
</li>

<div class="lang-separator">
<hr>
</div>
<li class="nav-right">
<a class="page-link" href="/en/it/2024/07/07/thinkpad-x220-second-life.html">EN</a>
</li>
<li class="nav-right"><a class="page-link active">RU</a></li>
</ul></div>
</div>
</header>
<section class="page-banner">
<div class="page-banner-img">
<div style="background-image: url(/assets/static/header-make-thinkpad-cool-again.jpg)"></div>
</div>
<div class="wrapper">
<div class="page-banner-inner">
<header class="post-header">
<h1 class="post-title p-name" itemprop="name headline">Вторая жизнь для Thinkpad X220</h1>
<p class="post-meta">
<time class="dt-published" datetime="2024-07-07T00:00:00+03:00" itemprop="datePublished"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
2024.07.07
</time>
<span class="left-vsplit">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
it
</span>
</p>
<div class="post-tags"><a class="post-tag" href="/tags.html#thinkpad">#thinkpad</a></div></header>
</div>
</div>
</section><main class="page-content" aria-label="Content">
<div class="wrapper">
<div class="framework main">
<div class="post">
<section>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content e-content" itemprop="articleBody">
<p>
Lenovo Thinkpad X220 — одна из обожаемых мною моделей ноутбуков (вторая из
обожаемых — это Panasonic Toughbook CF-19). Прекрасная семирядная клавиатура,
где нашлось место для всех необходимых кнопок — есть даже отдельные кнопки для
<code>Home</code>, <code>End</code>, <code>Pause</code><sup><a id="fnr.pause" class="footref" href="#fn.pause" role="doc-backlink">1</a></sup> и <code>Insert</code>! Прочный корпус из магниевого сплава,
покрытый чем-то вроде резины для лучшей «хватабельности». Запоминающийся
внешний вид — угловатый чёрный прямоугольник, который выглядит строго и в то
же время достаточно ретро-футуристично. И сравнительно мощное железо, которым
можно пользоваться и по сей день.
</p>
<p>
Ах, если бы он ещё был произведён не Lenovo, а IBM, имел клавиатуру и
модульность как у <a href="https://chaos.social/@xtaran/112084915245772102">IBM Thinkpad 760XD</a>, а ещё механическую клавиатуру; и трекбол
как у Thinkpad 220 — то цены бы ему не было!
</p>
<div class="figure">
<p><img src="/assets/static/thinkpad220.jpg" alt="Thinkpad 220 with trackball" align="center">
</p>
<p style="text-align: center"><i>Автор: Matthew S. Smith / Lifewire</i></p>
</div>
<p>
Thinkpad X220 приглянулся мне ещё со времён университета. К сожалению, в те
давние времена такой ноутбук для безработного студента по стоимости не сильно
отличался от крыла для Боинга. Но годы шли и в один прекрасный момент я смог
таки побаловать себя и купил одну из машинок с «той самой» каноничной
клавиатурой с синим Enter'ом — дабы закрыть гештальт, так сказать.
</p>
<p>
Благо к 2019 году цены на бывший в употреблении Thinkpad X220 перестали быть
заградительными и я достаточно быстро нашёл ноутбук из Европы примерно за
19000 рублей (около 300$). Это была машина с четырёхъядерным Intel Core i7 на
2.7 GHz, 8 Gb оперативной памяти и с SSD. К счастью, его предыдущий владелец
был аккуратен и у ноутбука было лишь несколько светлых пятен на
матрице<sup><a id="fnr.ips_problem" class="footref" href="#fn.ips_problem" role="doc-backlink">2</a></sup> от случайных ударов и микроскопические потёртости на
углах крышки.
</p>
<p>
Идеальных вещей в этом мире не существует — в противном случае эта статья не
появилась бы, а инженеры умерли бы от скуки. За 4 года использования своего
ноутбука я столкнулся с рядом неудобств:
</p>
<ul class="org-ul">
<li>Вышеупомянутые пятна на экране. Это лечится, очевидно, заменой дисплея на
исправный.</li>
<li>Разрешение экрана 1366x768 — обрабатывать фотографии на нём <b>тяжело</b>, потому
что пиксели видно! В то же время я видел как люди спокойно обрабатывают
фотографии на макбуке с чуть большей диагональю экрана — ведь у него
разрешение 2560×1600 и фотографии выглядят достаточно чётко.</li>
<li>Whitelist в BIOS — не даёт подключать «не одобренные производителем»
WiFi-карты и прочую внутреннюю периферию, которая может быть даже лучше, чем
то, что было «одобрено».</li>
<li>Клавиатура с британской раскладкой, тогда как я привык к американской.</li>
</ul>
<p>
Ну и конечно же мне не давало покоя шило в известном месте. Модифицировать
столь популярный у технарей ноутбук это как устанавливать моды на Skyrim —
всегда можно добавить ещё что-нибудь интересное.
</p>
<p>
В современном скучном мире, когда в ответ на вышеупомянутые вызовы большинство
людей просто пожмёт плечами и купит новый ноутбук, по форме напоминающий
плоский кусок мыла и неотличимый от своих собратов на полке магазина — у всех
одинаково глянцевый экран, одинаково несъёмный аккумулятор, плоская островная
клавиатура, не дающая приятных тактильных ощущений при печати, и тачпад с
закосом под макбук — должен же кто-то продолжать делать весёлые вещи?
</p>
<div class="figure">
<p><img src="/assets/static/d71f964b-c3d0-d724-a205-dfe2fcbe9d5a.jpg" alt="meme" align="center">
</p>
</div>
<div class="outline-2">
<h2>TOC   <span class="tag"></span>
</h2>
<div class="outline-text-2">
<ul class="org-ul">
<li>
<a href="#new-screen-installation">Установка нового 2K экрана</a>
<ul class="org-ul">
<li><a href="#coreboot-flashing">Прошивка coreboot</a></li>
<li><a href="#set-new-display">Установка нового дисплея</a></li>
<li><a href="#new-display-freebsd">Новый дисплей и FreeBSD</a></li>
</ul>
</li>
<li><a href="#wifi-module-replacement">Замена WiFi модуля</a></li>
<li><a href="#keyboard-replacement">Замена клавиатуры</a></li>
<li>
<a href="#notebook-power">Питание ноутбука</a>
<ul class="org-ul">
<li><a href="#battery-recelling">Battery recelling</a></li>
<li><a href="#second-battery">Встраивание второго аккумулятора в ноутбук (незаконченное)</a></li>
</ul>
</li>
<li><a href="#additional-ports">Дополнительные разъёмы и кнопочки</a></li>
<li><a href="#new-case">Прошивка нового чехла</a></li>
<li><a href="#update-17-07-2024">Апдейт за 17.07.2024</a></li>
<li><a href="#update-22-12-2024">Апдейт за 22.12.2024</a></li>
<li><a href="#results">Итоговые результаты</a></li>
<li><a href="#notes">Примечания</a></li>
</ul>
</div>
</div>
<div id="outline-container-new-screen-installation" class="outline-2">
<h2 id="new-screen-installation">Установка нового 2K экрана</h2>
<div class="outline-text-2" id="text-new-screen-installation">
<p>
Естественно, я начал с того, что беспокоило меня больше всего — с
дисплея. Хотелось, чтобы у моего X220 был экран с разрешением как у макбука и
чтобы он был матовым — такой экран не будет бликовать и отпечатки пальцев на
нём будут менее заметны. Раньше у меня уже был Asus F6E с глянцевым дисплеем —
все отражения от окон, потолочных ламп и прочих источников освещения были
моими. Но когда привыкаешь — кажется будто всё удобно и проблем нет: «просто
яркость побольше сейчас выкручу и всё» 🤡.
</p>
<p>
Мне было известно, что некто <a href="https://nitrocaster.me/store/x220-x230-fhd-mod-kit.html">nitrocaster</a> делает HD-модификации для Thinkpad
X220 — но сейчас они уже out of stock в его магазине. Также, какой-то китаец
делал материнские платы с современным железом и (вроде как) 30-pin LVDS
разъёмом, который подходит для подключения современных дисплеев без применения
паяльника. Но, как я читал на Reddit'е, он устал и временно прекратил приём
заказов.
</p>
<p>
К счастью, на AliExpress нашлись <a href="https://aliexpress.ru/item/1005004222503527.html">платы расширения для Thinkpad</a>, добавляющие на
выбор поддержку FHD, 2K или 4K экранов. Инструкция по установке этих плат
ничем не лучше переведённых китайских даташитов на электронные компоненты, но
это меня не остановило — немедленно была куплена плата 2K-модификации, кабель
для дисплея и сам дисплей (уже у другого продавца). Повезло, ориентируясь
исключительно на отзывы вида: «купил этот дисплей для 2K-модификации своего
ThinkPad, всё работает, спасибо» — отыскать подходящий мне Sharp LQ125T1JW02.
</p>
<p>
В силу отсутствия хорошей документации, пришлось одним глазом смотреть в
китайскую инструкцию, другим в <a href="https://nitrocaster.me/files/x220.x230_fhd_mod_rev5_v0.2.pdf">PDF от nitrocaster</a>, а третьим — обращаться к
здравому смыслу и навыкам, полученным в университете (тот момент, когда
пририсовывание опыта в резюме — не поможет, фьюить-ха).
</p>
<p>
Самое простое это разборка ноутбука — его можно разобрать практически вслепую,
при помощи одной лишь отвёртки, <a href="https://download.lenovo.com/ibmdl/pub/pc/pccbbs/mobiles_pdf/0a60739_04.pdf">по мануалу</a>. А вот дальше начинается самое
интересное, несмотря на чёткое следование всем инструкциям…
</p>
<p>
Я снял резистор R318 и припаял по <i>одной</i> медной жиле к конденсаторам C137 и
C584 — эти жилы потом будут припаяны к плате модификации. Оказалось, что <b>очень
важно</b> использовать всего одну тоненькую жилу — даже несколько жил, свитых
вместе, легко оторвут контактную площадку вместе с самим конденсатором. В
первую попытку модификации X220 у меня именно это и случилось — пришлось
подпаиваться к переходному отверстию, куда уходила оторванная дорожка от
конденсатора C137:
</p>
<div class="figure">
<p><img src="/assets/static/soldered_via.jpg" alt="soldered via" align="center">
</p>
<p style="text-align: center"><i>Оторванный конденсатор и пайка к переходному отверстию</i></p>
</div>
<p>
К счастью, этот конденсатор оказался не особо нужен, ибо дорожка от него
уходила на разъём Display Port док-станции, чьи линии уже заняты платой
2K модификации:
</p>
<div class="figure">
<p><img src="/assets/static/dock_dp_schematic.jpg" alt="Dock-station Display Port schematics" align="center">
</p>
</div>
<p>
Дальше я взялся за китайскую плату. Мой экземпляр потребовал небольшой
обработки <del>напильником</del> надфилем и кусачками, ибо она была неаккуратно выкушена
из панели с платами после травления дорожек. Ещё были залужены две контактные
площадки (отмечены стрелками на фото), куда будут припаиваться жилы от
конденсаторов:
</p>
<div class="figure">
<p><img src="/assets/static/2K_mod_board.jpg" alt="preparing 2k mod board" align="center">
</p>
<p style="text-align: center"><i>Китайская плата 2K-модификации для Thinkpad X220</i></p>
</div>
<p>
После этого я аккуратно установил плату расширения на материнскую плату,
проверил, что ноги от разъёма для док-станции попадают в нужные отверстия:
</p>
<div class="figure">
<p><img src="/assets/static/dock_interface_contacts.jpg" alt="docking interface contacts" align="center">
</p>
</div>
<p>
И начал паять. Что именно надо паять понять просто — у соответствующих
отверстий есть золотое напыление. Для маленьких круглых отверстий пришлось
воткнуть в паяльник самое тонкое и острое жало, чтобы дотянуться до ножек
разъёма для док-станции и прогреть припой вокруг них.
</p>
<p>
Поскольку к 2011 году всех, кто производит потребительскую электронику, уже
успели перевести на бессвинцовый припой — естественно ничего не прогрелось и
не припаялось. Пришлось немного повысить температуру паяльника и подмешать
нормальный, т.е. свинцовый, припой к месту пайки, чтобы олово начало
плавиться. Только после этого у меня что-то да получилось. Естественно,
использовался подходящий для микроэлектроники флюс (не канифоль, не кислотный
и не ЛТИ 120) — без него вообще бы ничего не получилось.
</p>
<div class="figure">
<p><img src="/assets/static/soldered_2k_board.jpg" alt="2k mod soldered" align="center">
</p>
<p style="text-align: center"><i>Припаянная плата 2K-модификации</i></p>
</div>
<p>
Как видно, тут я отклеил плёнку от места для пайки, припаял плату 2K-мода, а
потом закрыл всё плёнкой, прорезав окошко для разъёма LVDS. Таким образом,
случайно пролитая вода не попадёт ни на одну из плат и спокойно уйдёт в
сточные отверстия, как и задумывалось инженерами IBM.
</p>
<div class="figure">
<p><img src="/assets/static/covered_2k_board.jpg" alt="2k mod covered" align="center">
</p>
<p style="text-align: center"><i>Установленная и закрытая защитной плёнкой плата 2K-модификации</i></p>
</div>
<p>
С первого раза 2К экран конечно же не заработал. Сначала внешний дисплей даже
не включался и отсутствовал в выводе <code>xrandr</code>, но после того как я постучал
пластмассовой палочкой по плате расширения — он <i>внезапно</i> появился в выдаче
утилиты. Дальнейшее стучание по плате привело к тому, что изображение на новом
дисплее начало моргать и пошло разноцветными полосами — как при повреждённом
видеокабеле. Поскольку «электроника это наука о контактах» — очевидно, что
одно из миниатюрных круглых отверстий не соединилось с ножкой разъёма на
материнской плате. Или, вероятно, пайка была плохой и треснула от
ударов. Пришлось снова отсоединять материнскую плату от периферии и ещё раз
пропаивать плату 2K мода. В процессе выяснилось, что при первой пайке паяльник
не был достаточно горячим — иногда он прилипал к олову только что запаянного
отверстия — но в первый раз я не обратил на это внимания.
</p>
<p>
После повторной пайки контактов новый дисплей сразу же заработал и никак не
реагировал на стучание по плате расширения:
</p>
<div class="figure">
<p><img src="/assets/static/2K_display.jpg" alt="2k display working" align="center">
</p>
</div>
<p>
Впрочем, разноцветные полосы на экране — не единственный признак проблем с
контактами. У меня новый дисплей иногда не включался и распознавался <code>xrandr</code>
как имеющий разрешение 640x480. А ещё, после выключения обоих дисплеев для
энергосбережения — основной дисплей включался, а на новом включалась только
лишь подсветка, но изображение не появлялось. Все эти проблемы также решились
повторной пропайкой круглых контактов на плате расширения.
</p>
<p>
Но на этом мои приключения с паяльником не закончились, ибо я случайно сжёг
материнскую плату…
</p>
<p>
Впервые, за всё то время что этот ноутбук был у меня, я установил на него
Windows. После такого кощунства<sup><a id="fnr.1st_mb_fail" class="footref" href="#fn.1st_mb_fail" role="doc-backlink">3</a></sup> он намертво завис — да так, что
даже не реагировал на долгое нажатие кнопки включения питания. Ну а я взял и
необдуманно выдернул из работающего ноутбука аккумулятор — и дальше он уже не
включался, просто моргал один раз кнопкой включения питания и всё…
</p>
<div class="youtube-container">
<iframe class="youtube-iframe" src="https://www.youtube-nocookie.com/embed/W87wOCSPA08?si=3oO6xT0UDTBApf6I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
<br>
<p>
Если оставить плату полежать полдня на верстаке, чтобы фиксики отдохнули без
напряжения — она всё-таки включалась. Правда примерно на полчаса, после чего
симптомы зависания повторялись, увы, уже в любой операционной системе. В
попытках починить всё, я дошёл до микросхемы контроля питания для
ноутбуков (<code>U59</code>) — успел проверить, что все линии питания, подходящие к этой
микросхеме, действительно это питание подают — и 3.3 В, и 5 В, и 17 В, и 20 В.
</p>
<div class="figure">
<p><img src="/assets/static/u59.jpg" alt="U59 microchip" align="center">
</p>
</div>
<p>
Хэппи-энда увы не будет. Когда я начал проверять, что там на сигнальных
входах, у меня дрогнула рука и линия питания на 17 В была замкнута на одну из
сигнальных линий. После чего, скорее всего что-то сгорело либо в схеме, идущей
от разъёма зарядки/внешнего питания, либо где-то в районе преобразователей
напряжения на 3.3/5 В. Шёл уже седьмой день копания в нерабочей плате (сначала
я думал, что проблема в BIOS'е и экспериментировал с ним), всё это меня
изрядно задолбало — и я просто поступил согласно сервисному мануалу от
Lenovo — закинул в угол сломанную плату и поставил заведомо рабочую. Мне
повезло найти оригинальную работающую плату с Core i7 на Авито, у человека,
который продавал свой старый ноутбук.
</p>
<p>
Поскольку рука уже была набита — на вторую материнскую плату я припаял всё что
надо не приходя в сознание и 2K модификация заработала с первого раза. Так что
могу сказать, что это не самый сложный этап модификации ноутбука, главное
никуда не торопиться и аккуратно паять.
</p>
</div>
<div id="outline-container-coreboot-flashing" class="outline-3">
<h3 id="coreboot-flashing">Прошивка coreboot</h3>
<div class="outline-text-3" id="text-coreboot-flashing">
<p>
К сожалению, новый дисплей не работал ни в BIOS, ни в GRUB — только в Linux:
</p>
<div class="figure">
<p><img src="/assets/static/no_bios.jpg" alt="2k display doesn't show bios" align="center">
</p>
</div>
<p>
Настройка <code>Config-&gt;Display</code> в BIOS'е не помогала, а китайский продавец на
вопросы отвечал с огромной задержкой, поэтому пришлось справляться своими
силами. Я заметил, что дисплей включается, когда Linux переключает режим
вывода с текстового на framebuffer. И предположил, что если BIOS тоже будет
делать такое же переключение, то проблема решится.
</p>
<p>
Официальный BIOS, естественно, так делать не умеет. Но в половине историй про
переделку Thinkpad X220 я встречал упоминание coreboot. И как раз, в вики
этого проекта нашлось упоминание некоей libgfxinit, которая умеет
устанавливать другой видеорежим, помимо текстового.
</p>
<p>
К счастью, прошивать coreboot оказалось гораздо проще, чем перепрошивать
оригинальный BIOS. В случае последнего надо где-нибудь найти Windows,
установить её на ноутбук или сделать загрузочную флешку (<code>dd</code> тут увы не
поможет), подключить аккумулятор, причём обязательно заряженный — иначе
привередливая программа для обновления BIOS'а откажется что-либо делать.
</p>
<div class="figure">
<p><img src="/assets/static/flashing_original_bios.jpg" alt="Flashing original BIOS" align="center">
</p>
<p style="text-align: center"><i>Обновление BIOS на ThinkPad'е</i></p>
</div>
<p>
А для coreboot нужно лишь следующее:
</p>
<ul class="org-ul">
<li>Физический доступ к чипу BIOS (в левом нижнем углу платы, рядом с корзиной
для карты PCI-Express)</li>
<li>Программатор для чипов флэш-памяти с интерфейсом SPI, например CH341.</li>
</ul>
<div class="figure">
<p><img src="/assets/static/bios_chip.jpg" alt="BIOS chip" align="center">
</p>
<p style="text-align: center"><i>Судя по маркировке, у меня чип Macronix MX25L6406E</i></p>
</div>
<p>
Процедура прошивки coreboot максимально простая и привычная для разработчика
встраиваемых систем — плата отключается от питания и периферии и на неё с
компьютера через программатор заливается бинарник с прошивкой. Делается всё
это через утилиту <code>flashrom</code>, которой до лампочки какой там аккумулятор у
ноутбука, насколько он заряжен и какая сейчас фаза Луны.
</p>
<p>
Первое время я использовал «прищепку» для корпуса SOP-8 — во всех гайдах
рекомендовали использовать её «для удобства», чтобы ничего не пришлось паять:
</p>
<div class="figure">
<p><img src="/assets/static/connected_ch341.jpg" alt="Connected CH341 programmer" align="center">
</p>
<p style="text-align: center"><i>«Прищепка» для подключения к чипу флеш-памяти</i></p>
</div>
<p>
Но всеми этими советами: «как бы всё сделать без паяльника» — оказалась
выложена дорога в ад. На второй материнской плате был установлен чип Winbond
W25Q64CV — который, судя по сообщениям от людей, тоже пытавшихся залить на
него coreboot — весьма требователен к качеству подводимых к нему сигнальных
линий, в отличие от чипа от Macronix. Требуются максимально короткие линии
одинаковой длины и надёжный контакт с ногами чипа — поэтому, в конечном итоге
мне всё равно пришлось подпаиваться к микросхеме флеш-памяти — благо, нужно
было всего лишь подпаяться к ногам с интерфейсом SPI и к питанию микросхемы.
</p>
<div class="figure">
<p><img src="/assets/static/connected_ch341_2.jpg" alt="Connected CH341 programmer" align="center">
</p>
<p style="text-align: center"><i>Припаянный к чипу шлейф от программатора</i></p>
</div>
<p>
С 30-сантиметровым же шлейфом от «прищепки», из чипа от Winbond у меня
читалось непонятно что, а запись чаще всего заканчивалась с ошибками. Именно
так, оригинальный BIOS от материнской платы №2 был навсегда утерян… Мне
«повезло», что за два чтения дампа из чипа — неправильно прочитанные биты были
в одних и тех же местах.
</p>
<pre class="example">
$ cd bios/
$ sudo flashrom -p ch341a_spi -r bios_thinkpad_x220_original.rom -V
$ sudo flashrom -p ch341a_spi -r 02.rom -V
$ md5sum *.rom
8e7e07cf8cf2f1e8df5fe66cfd92dcb8  02.rom
8e7e07cf8cf2f1e8df5fe66cfd92dcb8  bios_thinkpad_x220_original.rom
</pre>
<p>
Видимо, именно поэтому после подключения программатора, советуют прочитать
содержимое чипа как минимум три раза.
</p>
<p>
Дальнейшие мои действия опирались на вот эти посты: <a href="https://szclsya.me/posts/coreboot/x220/">раз</a> и <a href="https://brycevandegrift.xyz/blog/corebooting-a-thinkpad-x220/">два</a>. После
нескольких дней экспериментов с первой платой, пока она ещё не сгорела,
выяснилось следующее:
</p>
<ul class="org-ul">
<li>coreboot с Legacy инициализацией видео и без Video BIOS не умеет
отображаться на втором (2K) дисплее.</li>
<li>coreboot с Legacy инициализацией видео и с Video BIOS, который я скачал у
человека, собиравшего coreboot для Thinkpad X220 — выдаёт зелёные квадраты
на основном дисплее, второй дисплей в в принципе не работает. После зелёных
квадратов coreboot виснет намертво.</li>
<li>
<p>
coreboot с libgfxinit — не отображается на втором дисплее. И ещё не
поддерживает загрузку ОС в текстовом режиме. Например, вместо текстового
установщика FreeBSD в верхней части экрана видна узкая полоса с чем-то,
наподобие видеопомех<sup><a id="fnr.freebsd_coreboot_fix" class="footref" href="#fn.freebsd_coreboot_fix" role="doc-backlink">4</a></sup>.
</p>
<div class="figure">
<p><img src="/assets/static/freebsd_n_corebootfb.jpg" alt="freebsd livecd and corebootfb" align="center">
</p>
</div>
</li>
<li>китайский BIOS, который даунгрейднут до 1.44 и пропатчен особыми китайскими
патчами именно для моей платы 2K модификации — тоже не умеет отображаться на
втором дисплее.</li>
</ul>
<p>
После такого я полёз в исходники coreboot, где быстро выяснил следующее:
</p>
<ol class="org-ol">
<li>Видеовыход DP3, к которому подключается мой 2K монитор через плату
расширения — описан и в исходном коде coreboot, и в исходном коде
libgfxinit.</li>
<li>Если поправить код на языке Ада для libgfxinit, чтобы она инициализировала
DP3 на старте вместо системного LVDS — мой 2K дисплей всё равно ничего не
показывает.</li>
<li>Если скачать даташит на дисплей, прописать в коде coreboot нужные тайминги
в коде инициализации видео для платформы Lenovo X220 и инициализировать DP3
на старте в legacy видео-режиме — дисплей всё равно ничего показывать не
будет.</li>
</ol>
<p>
Тут мне либо не хватило понимания языка Ада, либо документации об
инициализации встроенного видеоядра Intel GMA 3000 на моём CPU («благо»
<i>пользовательскую</i> документацию от Intel на это не самое свежее видеоядро теперь
можно скачать разве что в даркнете 🤡🤡🤡) — в конечном итоге мой высокочёткий
дисплей по прежнему заводился лишь внутри ОС.
</p>
<p>
Впрочем, смысл от coreboot на Thinkpad X220 по прежнему был. Во-первых, всё
что мне надо от биоса, это:
</p>
<ul class="org-ul">
<li>уметь запускать загрузчик с жёсткого диска</li>
<li>уметь менять местами клавиши Ctrl и Fn — для меня Ctrl это обязательно левая
нижняя клавиша клавиатуры. Это <b>база</b>.</li>
</ul>
<p>
Во-вторых, coreboot у меня запускался на порядок быстрее, чем оригинальный
BIOS. Даже несмотря на добавленную паузу в две секунды, чтобы успеть выбрать
другой диск для загрузки. В ситуации, когда у тебя дисплей начинает что-то
показывать только в момент загрузки ОС — хочется проскочить загрузку BIOS'а и
загрузчик ОС максимально быстро.
</p>
<p>
Подготовка к сборке coreboot достаточно проста и выполняется всего одной
командой, которая распиливает дамп оригинального BIOS на бинарные,
проприетарные блобы и отключает Intel ME:
</p>
<div class="org-src-container">
<pre class="src src-bash">git clone --recursive https://review.coreboot.org/coreboot.git &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    git clone https://github.com/corna/me_cleaner.git &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #657b83; font-weight: bold;">cd</span> coreboot/util/ifdtool &amp;&amp; make &amp;&amp; sudo make install &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #657b83; font-weight: bold;">cd</span> ../../../bios &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    python ../me_cleaner/me_cleaner.py -s bios_thinkpad_x220_original.rom -O working_copy.rom &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    ifdtool -x working_copy.rom &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    mkdir -p ../coreboot/3rdparty/blobs/mainboard/lenovo/x220/ &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    mv flashregion_0_flashdescriptor.bin ../coreboot/3rdparty/blobs/mainboard/lenovo/x220/descriptor.bin &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    mv flashregion_2_intel_me.bin ../coreboot/3rdparty/blobs/mainboard/lenovo/x220/me.bin &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    mv flashregion_3_gbe.bin ../coreboot/3rdparty/blobs/mainboard/lenovo/x220/gbe.bin &amp;&amp; <span style="color: #b58900; font-weight: bold;">\</span>
    rm flashregion*.bin working_copy.rom
</pre>
</div>
<p>
К счастью, мне повезло, и несмотря на то, что оригинальный BIOS со второй
материнской платы был прочитан с ошибками из-за использования «прищепки» и
впоследствии, после первой перепрошивки на coreboot, был утерян безвозвратно —
нужные области в полученном бинарнике не пострадали.
</p>
<p>
Я настроил coreboot под ThinkPad X220 следующим образом:
</p>
<pre class="example">
CONFIG_VENDOR_LENOVO=y
CONFIG_LINEAR_FRAMEBUFFER_MAX_HEIGHT=768
CONFIG_LINEAR_FRAMEBUFFER_MAX_WIDTH=1366
CONFIG_CONSOLE_POST=y
CONFIG_SEABIOS_PS2_TIMEOUT=3000
CONFIG_HAVE_IFD_BIN=y
CONFIG_BOARD_LENOVO_X220=y
CONFIG_PCIEXP_L1_SUB_STATE=y
CONFIG_PCIEXP_CLK_PM=y
CONFIG_H8_SUPPORT_BT_ON_WIFI=y
CONFIG_H8_FN_CTRL_SWAP=y
CONFIG_HAVE_ME_BIN=y
CONFIG_CHECK_ME=y
CONFIG_HAVE_GBE_BIN=y
CONFIG_GENERIC_LINEAR_FRAMEBUFFER=y
CONFIG_DRIVERS_PS2_KEYBOARD=y
CONFIG_COREINFO_SECONDARY_PAYLOAD=y
CONFIG_MEMTEST_SECONDARY_PAYLOAD=y
</pre>
<p>
И залил в материнскую плату №2 получившийся бинарник. И тут, <b>внезапно</b>,
началось время чудес! Почему-то coreboot отобразился на 2K дисплее! Ту же
самую конфигурацию coreboot я уже применял на первой плате и там что-то
показывалось только на оригинальном дисплее. Более того, в отзывах на
AliExpress один человек тоже писал, что у него не отображается coreboot на 2K
экране.
</p>
<p>
Также, <a href="https://mail.coreboot.org/pipermail/coreboot/2017-January/082956.html">в рассылке coreboot</a> я видел человека с аналогичной проблемой. И
единственный выход, который ему подсказали — либо дизассемблировать и патчить
оригинальный Video BIOS, чтобы он выводил видео не на LVDS, а на нужный
интерфейс. Либо переходить на libgfxinit и править её исходный код, чтобы при
старте системы использовался нужный видеовывод.
</p>
<p>
Почему вдруг всё заработало на второй материнской плате, которая отличается от
первой исключительно маркой чипа Flash-памяти для BIOS, и без каких-либо
правок исходного кода coreboot — я не знаю 🤷‍♂️.
</p>
<div class="figure">
<p><img src="/assets/static/IMG_20230327_151741_470.jpg" alt="Meme" align="center">
</p>
</div>
<p>
Возможно, с момента ответа на вышеупомянутое письмо в рассылке, разработчик
libgfxinit уже успел реализовать графический вывод на все, имеющиеся на плате,
интерфейсы. А с моей материнской платой №1 ничего не работало из-за того же,
из-за чего она в конечном итоге и померла. Возможно, при повторной пересборке
coreboot «с нуля» я включил пару опций, которых вроде как раньше не
было. Чтобы понять, что произошло — мне нужно немного больше оборудования, чем
у меня есть сейчас, и ещё несколько материнских плат и плат 2K-модификации для
тестирования. Проверять свои гипотезы на единственной (из двух) работающей
плате — я уж точно не готов.
</p>
</div>
</div>
<div id="outline-container-set-new-display" class="outline-3">
<h3 id="set-new-display">Установка нового дисплея</h3>
<div class="outline-text-3" id="text-set-new-display">
<p>
Осталось … установить дисплей на его законное место.
</p>
<div class="figure">
<p><img src="/assets/static/monitor.jpg" alt="monitor.jpg" align="center">
</p>
</div>
<p>
Сначала я разобрал оригинальный дисплейный модуль по сервисному
мануалу<sup><a id="fnr.display_module_disassemble" class="footref" href="#fn.display_module_disassemble" role="doc-backlink">5</a></sup> и вытащил оттуда всё ненужное:
</p>
<ul class="org-ul">
<li>Видеокабель к старому дисплею (проходит через левую петлю)</li>
<li>Сам дисплей</li>
<li>Провода к антеннам от WWAN-модуля — синий и красный (зачем я их снимал —
написал ниже, в разделе про WiFi-модуль)</li>
<li>Провод к антенне от WiFi-карты — чёрного цвета.</li>
</ul>
<p>
Ну и снял соответствующие антенны, ибо там, куда мы отправляемся — эти антенны
нам не понадобятся.
</p>
<div class="figure">
<p><img src="/assets/static/dismantle_wifi_antenna.jpeg" alt="WiFi antenna in the display case" align="center">
</p>
<p style="text-align: center"><i>Отклеивание ненужных WiFi антенн</i></p>
</div>
<p>
В итоге, у меня получилась такое:
</p>
<div class="figure">
<p><img src="/assets/static/notebook_lid.jpg" alt="Disassembled notebook lid" align="center">
</p>
</div>
<p>
Через левую петлю пойдёт видеокабель от нового дисплея. А через правую петлю
всё так же будет идти шлейф от камеры и от LED-board, вместе с кабелем от
последней оставшейся WiFi антенны.
</p>
<p>
Для того чтобы сюда влез новый дисплей — я занялся слесарными работами. Нижняя
часть моего 2K дисплея немного шире, чем у оригинального и, чтобы всё
поместилось внутрь крышки ноутбука, надо срезать металлические направляющие
для проводов рядом с петлями.
</p>
<div class="figure">
<p><img src="/assets/static/lid_parts2mill.jpg" alt="what to mill" align="center">
</p>
<p style="text-align: center"><i>Эти направляющие, рядом с обеими петлями, надо срезать</i></p>
</div>
<p>
У меня был лишь Dremel, отрезные диски по металлу и абразивные насадки для
шлифовки. Этого хватило, чтобы «слизать» ненужные направляющие. Но если вдруг
у вас завалялся фрезерный станок, то проще воспользоваться им! Говорят, что
результат будет ещё лучше и красивее.
</p>
<div class="figure">
<p><img src="/assets/static/lid_parts_milled.jpg" alt="milled parts on the lid" align="center">
</p>
<p style="text-align: center"><i>Срезанные направляющие для проводов</i></p>
</div>
<p>
Также, небольшой доработки напильником потребовала рамка для дисплея — надо
было немного подточить пластик, рядом с петлями, чтобы он не упирался в новый
дисплей. И ещё я откусил кусачками пару пластмассовых защёлок, ответные части
для которых были только что срезаны Dremel'ем.
</p>
<p>
Сам новый дисплей, увы, не имел никаких точек крепления. Это просто плоский
тонкий прямоугольник, в коробку с которым была вложена пара полосок
двустороннего скотча. Естественно, я не собирался уподобляться <i>современным</i>
производителям ноутбуков и вклеивать дисплей в крышку, чтобы потом всячески
мучиться при необходимости снять его — а снимать его придётся практически для
любых действий с антенной, камерой, подсветкой клавиатуры и т.д. и т.п.
</p>
<p>
И тут мой взгляд упал на снятый оригинальный дисплей — ведь он «лежит» в такой
удобной металлической рамке, в которой уже есть «ушки» под винты,
вкручивающиеся в крышку ноутбука:
</p>
<div class="figure">
<p><img src="/assets/static/back_of_original_display.jpg" alt="metal case for original display" align="center">
</p>
</div>
<p>
Кроме того, эта рамка позволяла легко выставить требуемую высоту нового
дисплея внутри крышки — его лицевая сторона должна быть на одном уровне с
проушинами, по аналогии с оригинальным дисплеем:
</p>
<div class="figure">
<p><img src="/assets/static/old_display_height.jpg" alt="old display height" align="center">
</p>
</div>
<p>
Старый дисплей был немедленно разобран на полезные составляющие — на
металлическую рамку, от которой были отпилены крепления снизу для управляющей
платы оригинального дисплея и П-образный загиб в нижней «перекладине». И на
кусок прозрачного пластика, который идеально дополнял по высоте новый
дисплей. Всё это было склеено друг с другом клеем «Момент» и двусторонним
скотчем — и в итоге на свет появился новый 2K дисплейный модуль, который при
желании можно снять одной лишь крестовой отвёрткой, без фена и лишних
страданий.
</p>
<div class="figure">
<p><img src="/assets/static/case_for_new_display.jpg" alt="case for new display module" align="center">
</p>
<p style="text-align: center"><i>«Корзина» для 2K-дисплея</i></p>
</div>
<div class="figure">
<p><img src="/assets/static/new_display.jpg" alt="new 2K display" align="center">
</p>
<p style="text-align: center"><i>Установленный новый дисплей</i></p>
</div>
<p>
Остался финальный штрих. Я оторвал логотип Lenovo с крышки и залил выемку под
него эпоксидкой. С логотипом под дисплеем всё не так просто — белая краска там
идёт по всей толщине пластика в рамке и оторвать или зашлифовать логотип не
получится — тут только заклеивать. После, я заказал в типографии стикеры с
логотипом IBM на матовой бумаге, раскроил их ножом под нужные мне размеры и
приклеил куда надо:
</p>
<div class="figure">
<p><img src="/assets/static/logos.webp" alt="IBM logos" align="center">
</p>
</div>
<p>
Очевидно, что после всех «нововведений» Lenovo, когда они то уничтожают
7-рядную красивую клавиатуру, то убирают отдельные кнопки для трэкпойнта, то
убирают возможность подцеплять снизу к ноутбуку док-станцию и аккумулятор — то
есть старательно превращают Thinkpad в обычный ноутбук «как у всех»,
обосновывая это «будущим», «инновациями» и тем, что старые фанаты Thinkpad'ов
<i>должны приспосабливаться</i> (🤡) — мне они не очень-то и нравятся.
</p>
<div class="figure">
<p><img src="/assets/static/whattheytookfromus.jpg" alt="what they took from us" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/peakperformance.jpg" alt="peak performance now" align="center">
</p>
</div>
</div>
</div>
<div id="outline-container-new-display-freebsd" class="outline-3">
<h3 id="new-display-freebsd">Новый дисплей и FreeBSD</h3>
<div class="outline-text-3" id="text-new-display-freebsd">
<p>
Естественно, что новая плата, припаянная к материнке, и новый дисплей
потребовали определённых изменений и в софте. Сначала я настроил DPI <a href="https://wiki.archlinux.org/title/HiDPI#X_Resources">по
инструкции</a> (<a href="https://codeberg.org/evgandr/dotfiles/commit/67ae822f43067ce12f8a928c7b89935f973b7fb5">вот так</a>), чтобы можно было работать за ноутбуком без лупы.
</p>
<p>
Чтобы не вводить каждый раз <code>vbe on</code> в загрузчике и видеть лог загрузки FreeBSD
на новом дисплее, а не узкую полоску «видеопомех» вверху экрана — в
<code>/boot/loader.conf</code> я добавил пару строк:
</p>
<pre class="example">
hw.vga.textmode="0"
vbe_max_resolution=2560x1440
</pre>
<p>
Чтобы отключить вывод LVDS при старте X-сервера — использовал стандартные
утилиты <code>xrandr</code> и <code>backlight</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash">xrandr --output LVDS-1 --off
xrandr --output DP-3 --primary
backlight 0
</pre>
</div>
<p>
Для изменения яркости стандартными кнопками на клавиатуре Thinkpad, пришлось
покопаться в системе чуть побольше. Китайцы сделали очень затейливую
регулировку яркости для нового дисплея — короткое нажатие на кнопку питания
циклически меняет яркость с минимума на максимум и обратно. Драйвера, которые
возвращают <i>нормальную</i> регулировку яркости по кнопкам на клавиатуре — есть
только под Windows и работают они только с китайским, пропатченным BIOS'ом. В
Linux и *BSD придётся справляться своими силами (не к ChatGPT же за советом
тут обращаться 😄…).
</p>
<p>
Сначала пришлось продираться сквозь тонны глупых советов с форумов, где
предлагали регулировать яркость внешних (относительно LVDS в ноутбуке)
дисплеев через <code>xbacklight</code>, <code>xgamma</code>, <code>redshift</code> и прочие утилиты, которые просто
меняют цветовую гамму и не трогают реальную физическую подсветку… Такое
«изменение» яркости никак не повлияет на скорость разрядки батареи ноутбука.
</p>
<p>
Потом я нашёл вот эту очень полезную ветку на форуме владельцев Thinkpad: <a href="https://forum.thinkpads.com/viewtopic.php?f=43&t=125030">x220
x230 FHD WQHD 2K mSATA USB3.0</a> (они зачем-то заблокировали доступ
пользователям из РФ 🤡, так что просто так ссылка не откроется). Содержимое
этой ветки подтолкнуло меня в сторону копания в USB-интерфейсе, который
используется платой 2K-модификации. К сожалению, к этому моменту я уже собрал
ноутбук и очень не хотел его разбирать обратно, поэтому доступа к припаянной
плате 2K-модификации, чтобы прозвонить линии разъёма <code>CN15</code>, идущего к
док-станции — у меня не было.
</p>
<p>
Зато, у меня было кое-что получше — фотография контактов порта для док-станции
с припаянной к ним платой расширения! А также сгоревшая материнская плата №1 и
принципиальная электрическая схема ноутбука. На первый взгляд кажется, что
ловить тут нечего:
</p>
<div class="figure">
<p><img src="/assets/static/cn15.png" alt="photo and schematic of CN15" align="center">
</p>
<p style="text-align: center"><i>Разъём CN15 для док-станции</i></p>
</div>
<p>
А потом я вспоминаю, что смотрю на плату с обратной стороны, зеркалю чертёж —
и уже вырисовывается что-то похожее на правду:
</p>
<div class="figure">
<p><img src="/assets/static/cn15-mirrored.png" alt="photo and schematic of CN15" align="center">
</p>
<p style="text-align: center"><i>Отзеркаленный разъём CN15</i></p>
</div>
<p>
В итоге, у меня получилось легко и просто сматчить ноги реального интерфейса и
его символ на электрической схеме:
</p>
<div class="figure">
<p><img src="/assets/static/cn15-correspondence1.png" alt="photo and schematic of CN15" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/cn15-correspondence2.png" alt="photo and schematic of CN15" align="center">
</p>
</div>
<p>
Теперь, по фотографии платы 2K-расширения уже можно понять какие именно линии
<code>CN15</code> использует китайская плата:
</p>
<div class="figure">
<p><img src="/assets/static/2K_board_lines.jpg" alt="CN15 lines for 2K mod" align="center">
</p>
</div>
<p>
Из интересного тут:
</p>
<ul class="org-ul">
<li>Линии I2C интерфейса Display Port к новому монитору: <code>DOCKB_DP_DDC_DATA</code>,
<code>DOCKB_DP_DDC_CLK</code>.</li>
<li>Линии от USB-интерфейса к плате 2K-модификации: <code>USBP8-</code> и <code>USBP8+</code>. Другим
концом они уходят в Platform Controller Hub (PCH, <code>U14</code>).</li>
</ul>
<p>
В выхлопе <code>sudo usbconfig list</code> было несколько интересных строчек:
</p>
<pre class="example">
ugen0.2: &lt;vendor 0x8087 product 0x0024&gt; at usbus0, cfg=0 md=HOST spd=HIGH (480Mbps) pwr=SAVE (0mA)
ugen2.2: &lt;vendor 0x8087 product 0x0024&gt; at usbus2, cfg=0 md=HOST spd=HIGH (480Mbps) pwr=SAVE (0mA)
ugen0.3: &lt;AGAN X230&gt; at usbus0, cfg=0 md=HOST spd=FULL (12Mbps) pwr=ON (64mA)
ugen2.3: &lt;vendor 0x8087 product 0x0a2b&gt; at usbus2, cfg=0 md=HOST spd=FULL (12Mbps) pwr=ON (100mA)
</pre>
<p>
Первые две строчки и последняя оказались девайсами от Intel (см. <a href="http://www.linux-usb.org/usb.ids">ссылку</a>):
</p>
<pre class="example">
8087  Intel Corp.
    0020  Integrated Rate Matching Hub
    0024  Integrated Rate Matching Hub
    0a2b  Bluetooth wireless interface
</pre>
<p>
А вот поиск по <code>AGAN X230</code> привёл к <a href="https://github.com/xy-tech/agan_brightness_X230_X330">GitHub-репозиторию</a> одного тайваньца и далее
к <a href="https://www.xyte.ch/mods/x230/">его сайту</a>, посвящённому модификации Thinkpad'ов. Оттуда я узнал больше
подробностей о своём 2K-моде — оказывается, его сделал некий китайский моддер
阿甘, известный в миру как <i>a.gain</i>. А из GitHub-репозитория стало понятно, что
я нахожусь на верном пути и яркость 2K-дисплея можно менять через
USB-интерфейс платы.
</p>
<p>
К сожалению, код из вышеупомянутого репозитория не отличался совершенством,
поэтому я написал свою программу, поглядывая одним глазом в репозиторий
<code>xy-tech/agan_brightness_X230_X330</code>. У меня есть:
</p>
<ul class="org-ul">
<li>Причёсанный код на C.</li>
<li>Разбор опций командной строки через libpopt (а не вручную, через <code>atoi</code>;
заодно и красивый вывод <code>--help</code> автоматически генерируется).</li>
<li>Сборка через autotools.</li>
<li>Man-страница.</li>
<li>Правило для devd, чтобы утилитой можно было пользоваться без повышения
привилегий до <code>root</code>.</li>
</ul>
<p>
Программа написана под FreeBSD, но, вероятно, при наличии установленной
библиотеки <a href="https://github.com/libusb/hidapi">libusbhid</a> и её заголовочных файлов — она заработает и под
Linux. Правда, вместо правила для devd придётся изобретать что-то своё.
</p>
<p>
Проверял я её только под FreeBSD 14.0 — на моей машине всё
работает 😊. Исходники скачать можно вот тут:
<a href="https://codeberg.org/evgandr/brightness_x220_agan2k">https://codeberg.org/evgandr/brightness_x220_agan2k</a>, там же лежит и инструкция
по использованию.
</p>
</div>
</div>
</div>
<div id="outline-container-wifi-module-replacement" class="outline-2">
<h2 id="wifi-module-replacement">Замена WiFi модуля</h2>
<div class="outline-text-2" id="text-wifi-module-replacement">
<p>
Дальше меня было уже не остановить. Заменив оригинальный BIOS на coreboot, я
столкнулся с тем, что могу воткнуть в ноутбук любое подходящее периферийное
устройство и не мучиться с whitelist'ом.
</p>
<p>
Начал я с WiFi. Изначально в Thinkpad X220 установлена карта на 2.4 GHz и на
300 Mbps (802.11b/g/n). К счастью, после избавления от whitelist'а (и от
оригинального BIOS'а) можно установить <a href="https://aliexpress.ru/item/32853420688.html">совсем другой WiFi модуль</a> (TL-8260D2W)
— с поддержкой диапазонов 2.4 и 5 GHz, со скоростью примерно на 800-900 Mbps и
с поддержкой стандартов 802.11b/g/n/ac. Главное заклеить 51 пин, иначе
встроенный Bluetooth не заработает.
</p>
<p>
Раз отдельная Bluetooth daughter card<sup><a id="fnr.bdc" class="footref" href="#fn.bdc" role="doc-backlink">6</a></sup> в ноутбуке больше не нужна — я снял
её и поставил в освободившийся разъём <a href="https://aliexpress.ru/item/1005002489857902.html">переходник с BDC на USB</a> — и в итоге
получил внутри ноутбука ещё один USB-разъём, к которому можно что-нибудь
подключить. Что именно — я пока так и не придумал. Два WiFi-модуля мне не
нужны, втыкать туда флешку слишком скучно, а GPS-донгл не поместится целиком
внутри корпуса.
</p>
<div class="figure">
<p><img src="/assets/static/bdc2usb.jpg" alt="USB instead of Bluetooth" align="center">
</p>
<p style="text-align: center"><i>Внутренний USB вместо Bluetooth</i></p>
</div>
<p>
Слева от WiFi-модуля у меня был установлен WWAN-модуль. Устанавливать для него
сим-карту я и не собирался, поэтому этот модуль тоже был снят, а его антенны
демонтированы. Вместо него был установлен SSD на полтерабайта, с интерфейсом
mSATA.
</p>
<p>
Также, я снял одну из антенн для WiFi-модуля. Вместо этой антенны будет стоять
внешняя антенна. Хоть я и не занимаюсь всяким пентестингом и дальнобойность
ноутбучного WiFi мне не сильно важна — но ноутбук с внешней антенной будет
выглядеть просто офигенно!
</p>
<p>
Под разъём для внешней антенны как раз есть место рядом с Kensington-lock'ом:
</p>
<div class="figure">
<p><img src="/assets/static/kensington_lock.jpg" alt="place for wifi connector" align="center">
</p>
</div>
<p>
Рядом с предполагаемым отверстием есть винт, но если сверлить по чертежу, то
этот винт не будет мешать:
</p>
<div class="figure">
<p><img src="/assets/static/external_connector_drw.jpg" alt="external connector drawing" align="center">
</p>
<p style="text-align: center"><i>Чертёж отверстия (⌀ 6 мм) для разъёма RP-SMA</i></p>
</div>
<p>
Чтобы разъём можно было вставить в отверстие — была выфрезерована перемычка
внутри корпуса:
</p>
<div class="figure">
<p><img src="/assets/static/drilled_hole_wifi.jpeg" alt="Drilled hole" align="center">
</p>
<p style="text-align: center"><i>Просверленное отверстие и выфрезерованная перемычка внутри корпуса</i></p>
</div>
<p>
C Dremel'ем и с тремором — результат у меня получился не особо аккуратным. Но
всё равно всё будет закрыто кабелями, поэтому я лишь обточил все острые углы
надфилем и заизолировал открытый металл на всякий случай.
</p>
<p>
Ну а дальше удалось отыскать внешнюю антенну на 2.4 и 5 GHz в цветах
Thinkpad'а и 18-сантиметровый pigtail с RP-SMA с одной стороны и с
U.FL-разъёмом с другой стороны.
</p>
<div class="figure">
<p><img src="/assets/static/wifi_connector1.jpg" alt="External WiFi connector" align="center">
</p>
<p style="text-align: center"><i>Разъём RP-SMA в корпусе Thinkpad (вид сбоку)</i></p>
</div>
<div class="figure">
<p><img src="/assets/static/wifi_connector2.jpg" alt="External WiFi connector" align="center">
</p>
<p style="text-align: center"><i>Разъём RP-SMA в корпусе Thinkpad (вид сверху)</i></p>
</div>
<p>
Единственная сложная часть тут — проложить кабели правильным образом после их
выхода из под keyboard bezel. Иначе палмрест не защёлкнется до конца, ему
будет мешать кабель в канале для стока воды.
</p>
<div class="figure">
<p><img src="/assets/static/wifi_cables.jpg" alt="WiFi cables" align="center">
</p>
<p style="text-align: center"><i>Тут кабели ещё не проложены как надо</i></p>
</div>
<p>
Сама WiFi-карточка и встроенный в неё Bluetooth работают как часы — по крайней
мере в Linux для этого не пришлось ничего настраивать. Во FreeBSD разве что
пришлось установить пакет с бинарными, проприетарными блобами: <code>iwmbt-firmware</code>
и прописать <code>mode 11g</code> в строку с <code>ifconfig_wlan0=</code> в <code>/etc/rc.conf</code>. К сожалению,
поддержка стандарта 802.11ac для Intel 8260 во FreeBSD'шном iwlwifi ещё не
зарелизилась, поэтому новая карточка раскрывается не полностью. Но по-крайней
мере, в моём типовом сценарии использования — подключение к интернету через
WiFi с телефона — она работает без нареканий.
</p>
<div class="figure">
<p><img src="/assets/static/wifi.jpg" alt="installed wifi and antenna" align="center">
</p>
<p style="text-align: center"><i>Новая WiFi-карта и внешняя антенна</i></p>
</div>
</div>
</div>
<div id="outline-container-keyboard-replacement" class="outline-2">
<h2 id="keyboard-replacement">Замена клавиатуры</h2>
<div class="outline-text-2" id="text-keyboard-replacement">
<p>
Изначально, на моём ноутбуке была установлена клавиатура с британской
раскладкой<sup><a id="fnr.kbd_layouts" class="footref" href="#fn.kbd_layouts" role="doc-backlink">7</a></sup>, которая мне очень не нравится — я всегда пользовался
клавиатурами с американской раскладкой. Постоянно попадать пальцем по Enter,
когда ты хочешь ввести символ пайпа — раздражает.
</p>
<p>
К счастью, китайцы всё ещё выпускают клавиатуры под X220 с
кнопками-пирамидками и седьмым рядом, иначе этот мир был бы максимально
проклят. Нет серьёзно, вы только почитайте <a href="https://vermaden.wordpress.com/2022/02/07/epitaph-to-laptops/">эту статью</a> или взгляните на <a href="https://joyreactor.cc/post/5721593">этот
ад</a>:
</p>
<div class="figure">
<p><img src="/assets/static/cursed_kbd.webp" alt="cursed keyboards" align="center">
</p>
</div>
<p>
Пока зумеры пишут на клавиатурах с фото выше всякий кринж про трекпойнты в
духе: <a href="https://twitter.com/erhannah/status/1387447191506198528">«did anyone ever actually use this thing?»</a> — остальное прогрессивное
человечество, использующее ThinkPad'ы не только лишь для срачей в <del>Twitter</del> X,
нарабатывает <b>бесценный</b> опыт правильного движения пальцем по клитору!
</p>
<p>
К сожалению, у китайской клавиатуры для X220 был один фатальный
недостаток. Она просто некачественная:
</p>
<ol class="org-ol">
<li>Пластик не такой плотный и блестящий, как на старых клавиатурах. На ощупь
там используется что-то другое — соответственно ощущения при печати будут
уже не те.</li>
<li>Вместо оригинального «клитора» бугорком, используется плоский трекпойнт.</li>
<li>Символы на клавишах <code>Enter</code>, <code>Backspace</code>, <code>Shift</code> у китайцев зачем-то
продублированы текстом.</li>
<li>Вместо спокойного синего цвета для пиктограмм специальных функций —
используется более яркий голубой.</li>
<li>Над кнопкой включения питания тоже поиздевались — вместо мягкого зелёного
света в глаза бьёт яркий зелёный светодиод (памятуя любовь китайцев к ярким
и аляповатым штукам в дизайне — слава богу, что это не сверхъяркий синий
светодиод).</li>
<li>Мой экземпляр в целом не отличался качеством — несколько кнопок из верхнего
ряда клавиатуры прожимались с трудом, металлическая крышка на обратной
стороне клавиатуры была погнута.</li>
</ol>
<p>
К счастью, мне повезло найти оригинальную клавиатуру от ноутбука с британской
раскладкой. Вот фото для сравнения (снизу оригинальная клавиатура, сверху
китайская):
</p>
<div class="figure">
<p><img src="/assets/static/kbd_comp.jpg" alt="original and chinese keyboards" align="center">
</p>
</div>
<p>
Про саму замену клавиатуры писать особо нечего — просто снимается старая
клавиатура и устанавливается новая.
</p>
<p>
Ещё я очень хотел поменять местами клавиши Ctrl и Fn на новой клавиатуре. Они
и так уже были поменяны местами в coreboot, но надписи на самих клавишах не
давали мне покоя. Достаточно быстро выяснилось, что за десять лет никто так и
не наладил производство нужных кейкапов для оригинальной семирядной
клавиатуры. Пришлось справляться своими силами.
</p>
<p>
К счастью, клавиша Fn по размеру совпадает с правым Ctrl, так что тут всё
просто — надо <a href="https://www.ifixit.com/Guide/Lenovo+Thinkpad+X220+Individual+Keys+Replacement/56264">снять</a> правый Ctrl со старой клавиатуры и поставить его на место
левого Fn на новой. С левым Ctrl такой трюк уже не пройдёт — поэтому я снял
клавишу и вручную заполировал надпись на ней. Заодно, так же поступил и с
клавишей Super, на которой зачем-то нарисовали логотип Windows.
</p>
<div class="figure">
<p><img src="/assets/static/left_ctrl.jpg" alt="healed keyboard" align="center">
</p>
<p style="text-align: center"><i>После публикации этой фотографии в офисе IBM начался сущий кошмар</i></p>
</div>
</div>
</div>
<div id="outline-container-notebook-power" class="outline-2">
<h2 id="notebook-power">Питание ноутбука</h2>
<div class="outline-text-2" id="text-notebook-power">
<p>
Здесь я начал с замены зарядника. В принципе, оригинальный зарядник прекрасен
в своей надёжности и неубиваемости и менять его на что-то другое в общем-то и
незачем. Но я как раз наткнулся на GaN-зарядники и на аккумуляторы с
поддержкой протокола <a href="https://en.wikipedia.org/wiki/USB_hardware#USB_Power_Delivery">USB Power Delivery</a>, а также на <a href="https://aliexpress.ru/item/4001268721004.html">специальный кабель</a> для
зарядки ThinkPad'ов на AliExpress…
</p>
<p>
С одного конца у этого кабеля стандартный «бочонок» от thinkpad'овской
зарядки, а с другой стороны USB-C. С ним можно заряжать ноутбук при помощи
GaN-зарядника или аккумулятора с поддержкой протокола USB-PD. Главное, чтобы
один из их USB-C портов мог выдавать 20 В и <b>не меньше</b> 3.25 А.
</p>
<p>
И тут мне пришла в голову идея, что со всеми этими нововведениями я смогу
носить с собой <i>один</i> зарядник и <i>один</i> внешний аккумулятор и заряжать от них <i>всё</i>:
и ноутбук, и телефон, и вейп со спиннером. Эта идея прошла проверку на
практике после того как я купил зарядник и аккумулятор, оба на 140 Вт, от
Baseus — действительно, они одновременно заряжают и ноутбук, и телефон. Причём
последний ещё и в режиме турбозарядки, если использовать второй USB-C порт.
</p>
<p>
Ещё у меня была идея заменить стандартный «бочонок» на разъём USB-C (как в
телефоне и прочих современных электронных устройствах). Но посмотрев на <a href="https://www.xyte.ch/mods/x230/#x230-usb-c">опыт
других людей</a>, модифицировавших таким образом свой ThinkPad — я отказался от
этой затеи. Такой разъём не выглядит особо надёжным — уж лучше традиционный
«бочонок», он как-то понадёжнее выглядит.
</p>
</div>
<div id="outline-container-battery-recelling" class="outline-3">
<h3 id="battery-recelling">Battery recelling</h3>
<div class="outline-text-3" id="text-battery-recelling">
<p>
У меня было два, пострадавших от времени, аккумулятора:
</p>
<ol class="org-ol">
<li>Thinkpad Battery 29+ на 6 ячеек — с ним ноутбук жил около 55 минут.</li>
<li>Thinkpad Battery 29++ на 9 ячеек — с ним ноутбук жил полтора часа.</li>
</ol>
<p>
Как заменять полумёртвые ячейки в аккумуляторе я не знал, как и о «подводных
камнях» при выполнении такой операции. Знал лишь, что это <b>опасно</b> — если что-то
замкнуть или перегреть, то ячейка может загореться. Поэтому их нельзя паять —
допустима только точечная сварка. А ещё батареи немного теряют в ёмкости при
нагреве паяльником. Также, от нагрева может отказать пластмассовый
предохранительный клапан, расположенный в районе анода. Короче, просто <b>не надо</b>
паять аккумуляторы 18650, что бы ни писали в различных статьях в Интернете.
</p>
<p>
Поиск привёл меня в следующие места с полезной информацией:
</p>
<ul class="org-ul">
<li>
<a href="https://www.youtube.com/watch?v=Mkum7G-0vWg">This should be illegal… Battery Repair Blocking</a> — тут чуваки пересобирают
аккумулятор от камеры и в процессе проходятся по разным граблям, чтобы по
ним не пришлось проходиться мне.</li>
<li>
<a href="https://forum.thinkpads.com/viewtopic.php?t=135913">X220 Battery Recelling</a> — тут в конце топика есть много полезных советов от
мастера, занимающегося заменой ячеек в ноутбучных аккумуляторах.</li>
<li>
<a href="https://hackaday.io/page/247-replacing-lenovo-laptop-lithium-batteries">Replacing Lenovo laptop lithium batteries</a> и <a href="https://hackaday.io/project/245-replacing-lenovo-laptop-lithium-batteries/details">Project Details</a> — автор этих
статей обновлял аккумулятор не от X220, но из его статьи можно почерпнуть
полезные идеи о том, как провести замену ячеек в аккумуляторе. Также, в
конце второй статьи он пишет о том, что ёмкость ячеек по видимому
запрограммирована в BMS<sup><a id="fnr.bms" class="footref" href="#fn.bms" role="doc-backlink">8</a></sup> аккумулятора, поэтому нет смысла ставить ячейки
с ёмкостью большей, чем с завода, если нет программатора и исправленной
прошивки для BMS.</li>
<li>
<a href="https://www.coreboot.org/Board:lenovo/x220#Recalibrate_batteries">Recalibrate batteries</a> — тут описана команда из набора утилит coreboot
(<code>./ectool -w 0xb4 -z 0x06)</code> для калибровки батареи.</li>
</ul>
<p>
Вооружившись всеми этими знаниями, я принялся разбирать аккумулятор Thinkpad
Battery 29+ — его жалко меньше всего. Да и гореть он будет наверное поменьше,
чем большая батарея на 9 ячеек 😊.
</p>
<p>
Пришлось самостоятельно разбираться в том, как же аккуратно добраться до
внутренностей аккумулятора — ибо в разных видео с ютуба, где чуваки из ЮВА
якобы показывают как разобрать аккумулятор от Thinkpad, они по факту варварски
раздербанивают батарею, оставляя после себя гнутый во все стороны пластиковый
корпус и ошмётки никелевых шин. С тем же успехом можно было бы кинуть
аккумулятор в камнедробилку…
</p>
<p>
Верхняя крышка аккумулятора — та что с надписями «не вскрывать» и с
маркировкой — вклеена <b>в</b> основной корпус и дополнительно удерживается там
пластмассовыми защёлками. Мне повезло и я смог подлезть в щель между крышкой и
корпусом, в уголке — там где шов проходит сверху аккумулятора, а не
сбоку. Сначала, я разделял эти две части металлической лопаточкой, не залезая
глубоко внутрь, опасаясь как бы ничего не замкнуло и не загорелось.
</p>
<div class="figure">
<p><img src="/assets/static/battery29plus_open1.jpg" alt="start open 29plus battery" align="center">
</p>
</div>
<p>
Потом заточил палочку от мороженого, взял зубочистку и продолжил расклеивать
аккумулятор, используя деревянные инструменты если нужно было залезть куда-то
глубоко:
</p>
<div class="figure">
<p><img src="/assets/static/battery29plus_open2.jpg" alt="opening 29plus battery" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/battery29plus_open3.jpg" alt="opening 29plus battery" align="center">
</p>
</div>
<p>
Со швами, которые идут по боку аккумулятора пришлось заморочиться — я не сразу
понял как они устроены, в силу чего аккумулятор немного потерял свой товарный
вид 😊. Шов, который идёт справа со стороны разъёма, пришлось раскрывать очень
аккуратно — внутри корпуса там идёт изолированная шина, которую определённо не
стоит повреждать.
</p>
<p>
В конечном итоге, у меня всё получилось:
</p>
<div class="figure">
<p><img src="/assets/static/battery29plus_opened.jpg" alt="opened 29plus battery" align="center">
</p>
<p style="text-align: center"><i>Батарея 3S2P с подключенной платой BMS</i></p>
</div>
<p>
На фото выше к средней нижней ячейке приклеен датчик температуры, перегрев
которого приведёт к тому, что BMS сожжёт предохранитель (и, возможно,
установит внутри себя какой-нибудь Permanent Failure Flag) — и в итоге
аккумулятор совсем перестанет работать.
</p>
<p>
Оранжевые аккумуляторные ячейки на фото — LGABC21865, форм-фактор 18650, с
ёмкостью 2800 mAh каждая. Каждый аккумулятор выдаёт 3.7 В в норме,
максимально: 4.3 В — на эти числа стоит ориентироваться, чтобы ненароком не
купить аккумуляторы, рассчитанные на 4.2 В, как поступил один чувак с Реддита,
ненароком собравший ThinkBomb вместо ThinkPad.
</p>
<p>
Дальше самое сложное — надо так отключить старые аккумуляторы от BMS, чтобы он
не залочился. В Интернете, увы, не нашлось никакой информации по успешной
замене ячеек в аккумуляторах от Thinkpad X220. В основном находились лишь
советы по другим моделям Thinkpad'ов: кому-то помогало
<a href="https://www.yousun.org/archives/1572">отключение банок в нужном порядке</a>,
кто-то просто подключал 12 с лишним вольт от лабораторного источника питания к
клеммам платы BMS и у них контроллер аккумулятора не лочился (непонятно
почему — ведь на клеммах для контроля напряжения между ячейками тогда будет
0 В) и так далее.
</p>
<p>
Я попробовал разобраться во всём этом сам. Невосстанавливаемый предохранитель
я нашёл быстро — это деталь <code>F1</code>:
</p>
<div class="figure">
<p><img src="/assets/static/bms_fuse.jpg" alt="battery fuse" align="center">
</p>
<p style="text-align: center"><i>Fuse 12AH3</i></p>
</div>
<p>
Поиск по маркировке быстро выдал мне даташит с полезной картинкой:
</p>
<div class="figure">
<p><img src="/assets/static/bms_drawing.jpg" alt="fuse drawing" align="center">
</p>
</div>
<p>
Тут, в принципе, всё очевидно — надо временно отпаять вывод 4 от платы, чтобы
«обезвредить» предохранитель на время замены ячеек. К сожалению, это
SMD-деталь с выводами <b>под ней</b>, расположенная слишком близко к аккумуляторным
ячейкам для того, чтобы можно было снять её феном, поэтому от этой затеи я
отказался.
</p>
<p>
В даташите на чип BMS не нашлось ничего полезного, что могло бы натолкнуть
меня на мысль: «а как завести батарею после замены ячеек?» Увы, но оставался
лишь эксперимент с <i>правильной последовательностью отключения</i> банок от
аккумулятора, как описано по одной из ссылок выше.
</p>
<p>
Для теста, я отключил только лишь плюсовой вывод (<code>V+</code>) аккумуляторной сборки и
припаял его обратно. После этой операции на выходе аккумулятора, увы, было
0 В, хотя элемент <code>F1</code> по прежнему проводил ток. Но тут я вспомнил про то, как
«заводили» аккумуляторы от других Thinkpad'ов в одной из прочитанных
статей. Надо замкнуть на время плюсовой вывод аккумуляторной сборки и плюсовой
вывод разъёма аккумулятора. Я <b>прозвонил</b> и подпаял первый найденный на столе
проводок к <code>V+</code> и приложил его на секунду к нужному выводу разъёма.
</p>
<p>
На выходе аккумулятора всё равно было 0 В. Но тут я решил измерить напряжение
между концом провода и «землёй» (<code>V-</code>) аккумуляторной сборки. <b>Внезапно</b>, там было
не 12.2 В, а 4 В! Провод оказался сделанным из известной субстанции, был
немедленно выкинут, а на его место припаян качественный медный провод. После
повторения трюка с раъёмом акккумулятора — на его выходах появились столь
желанные 11 с лишним вольт!
</p>
<p>
Так и был найден рабочий метод отключения аккумулятора:
</p>
<ol class="org-ol">
<li>Убрать подальше от паяльника датчик температуры.</li>
<li>Отпаять плюсовой контакт аккумуляторной сборки: <code>V+</code>.</li>
<li>Отпаять следующий контакт: <code>VH</code>.</li>
<li>Отпаять ещё контакт: <code>VL</code>.</li>
<li>Отпаять минусовой контакт аккумуляторной сборки: <code>V-</code>.</li>
</ol>
<p>
Теперь плата BMS и аккумуляторы отсоединены друг от друга и можно заменять
ячейки на свежие! После завершения этого действа, подключать всё нужно в
обратном порядке:
</p>
<ol class="org-ol">
<li>Припаять последовательно, друг за другом разъёмы от аккумуляторной сборки к
соответствующим контактам: <code>V-</code>, <code>VL</code>, <code>VH</code>, <code>V+</code>.</li>
<li>Припаять качественный медный провод к <code>V+</code>.</li>
<li>Замкнуть на секунду второй конец провода и плюсовой контакт на разъёма
аккумулятора (самый левый контакт).</li>
</ol>
<p>
Готово, BMS должен вновь завестись и выдать напряжение на соответствующие
контакты разъёма аккумулятора.
</p>
<p>
К сожалению, я не могу утверждать что этот способ 100% рабочий, ибо не успел
проверить его как следует. Оказалось, что моя «гениальная» идея поскорее
почистить место пайки от флюса водкой, за неимением ничего более подходящего
под рукой поздно ночью — привела к фатальному провалу. Спирт испарился, вода
осталась и «внезапно» прямо на паяльной маске рядом с местом пайки —
мультиметр вдруг стал показывать 4 В вместо нуля. Естественно, BMS такое не
понравилось и он перестал работать — то ли залочился, то ли сгорел и повторное
выполнение вышенаписанной инструкции уже не помогало…
</p>
<p>
В итоге, и так уже потратив кучу времени на эксперименты с этим
аккумулятором — я решил потратить время на разбор отзывов к китайским
аккумуляторам и купил себе реплику ThinkPad Battery 29++. Мне повезло, и
полученная батарея оказалась нормальной — исправно заряжалась и обеспечивала
5-6 часов работы от аккумулятора при сёрфинге в Интернете.
</p>
</div>
</div>
<div id="outline-container-second-battery" class="outline-3">
<h3 id="second-battery">Встраивание второго аккумулятора в ноутбук (незаконченное)</h3>
<div class="outline-text-3" id="text-second-battery">
<p>
Уже очень давно я хотел добавить к ноутбуку вторую батарею — <a href="https://www.thinkwiki.org/wiki/ThinkPad_Battery_19%2B">ThinkPad Battery
19+</a>. Это большая, тяжёлая и надёжная батарея на 6 ячеек, которая крепится
снизу, к разъёму для док-станции. Как говорил Борис Бритва: «Тяжесть это
хорошо, тяжесть это надёжно».
</p>
<div class="figure">
<p><img src="/assets/static/ab95c10e2789777c99b9dd5b7b77a8590018c86a8910663dda47c1ac203a13de.jpg" alt="boris britva" align="center">
</p>
</div>
<p>
Я, мягко говоря, не являюсь фанатом современного тренда на безудержное
уменьшение толщины носимой техники любой ценой — ценой несъёмного вклеенного
аккумулятора, одинаковых плоских клавиатур, ценой удаления Ethernet-порта и
3.5 мм джека. Всё наоборот — мне очень нравится эстетика техники из фильмов
1980-1990 годов, которая выглядит умеренно толстой, имеет много полезных
кнопочек, индикаторов и портов:
</p>
<div class="figure">
<p><img src="/assets/static/old_school.webp" alt="cursed keyboards" align="center">
</p>
</div>
<p>
Может быть, когда я стану 90-летним старцем, меня будут волновать лишние
500 грамм веса и лишние миллиметры толщины. Но сейчас, переноска в рюкзаке
«лишних» полкило техники меня не парит — важнее, чтобы мой ноутбук выглядел
как стильный кирпичик из 90-х и вызывал приятные тактильные ощущения.
</p>
<p>
Особых проблем с поиском вышеупомянутой батареи на <i>вторичном рынке</i> я не
видел. Но, <b>внезапно</b>, оказалось, что в реальности такие аккумуляторы сейчас
можно найти лишь на недоступном мне eBay. Даже на AliExpress или на Авито их
нет.
</p>
<p>
Значит пришло время попробовать сделать такую батарею самому!
</p>
<p>
Для этого я купил док-станцию <a href="https://www.thinkwiki.org/wiki/ThinkPad_UltraBase_Series_3">ThinkPad UltraBase Series 3</a>. У меня была идея
подключить к ней вторую батарею на 9 ячеек <i>спереди</i>, как у ноутбука Dell
Latitude D630, чтобы она работала ещё и как palmrest. Свободное пространство в
задней части док-станции, там где в ThinkPad Battery 19+ по видимому и лежит
батарея на 6 ячеек, уже было занято платой с разнообразными разъёмами. Эту
плату я убирать не собирался, ибо хотел иметь разъёмы сзади ноутбука. В итоге
должен был получиться «стильный кирпич» в стиле 90-х, как я и хотел.
</p>
<p>
Для начала, я всё разобрал. Инструкции для этой док-станции я не нашёл, но
смог отыскать <a href="https://joes-tech-blog.blogspot.com/2017/09/whats-inside-lenovo-docking-station-for.html">пост про разборку</a> похожей. С ним стало понятнее, что там вообще
внутри стоит ожидать.
</p>
<p>
Сначала я открутил <b>все</b> винты, разщёлкнул пластиковые защёлки на верхней крышке
и снял её:
</p>
<div class="figure">
<p><img src="/assets/static/dock_screws.jpg" alt="dock station screws" align="center">
</p>
<p style="text-align: center"><i>15 винтов на верхней крышке док-станции</i></p>
</div>
<p>
Внутри есть основная плата с docking-разъёмом и механика для соединения
док-станции с ноутбуком:
</p>
<div class="figure">
<p><img src="/assets/static/dock_internals.jpg" alt="dock station internals" align="center">
</p>
<p style="text-align: center"><i>Внутренности док-станции UltraBase Series 3</i></p>
</div>
<p>
Под платой находится механическая часть док-станции и <i>много</i> смазки:
</p>
<div class="figure">
<p><img src="/assets/static/dock_mechanics.jpg" alt="dock stattion mechanics" align="center">
</p>
</div>
<p>
Осталось понять, как сюда подключить вторую батарею. Если взять основную
батарею, то разъём для её подключения (<code>CN23</code>) на принципиальной схеме выглядит
вот так:
</p>
<div class="figure">
<p><img src="/assets/static/bat1_schematics.png" alt="battery 0 schematics" align="center">
</p>
</div>
<p>
Видно, что от батареи идёт 5 линий:
</p>
<ul class="org-ul">
<li>Питание: <code>M-BAT-PWR_IN</code>, он же <code>BAT_VCC</code> на разъёме</li>
<li>Земля</li>
<li>Линии интерфейса SMBus: <code>I2C_CLK_BT0</code> и <code>I2C_DATA_BT0</code>
</li>
<li>Сигнал <code>M_TEMP</code> от вывода <code>TEMP</code> на разъёме <code>CN23</code>.</li>
</ul>
<p>
На этом же листе со схемой, видны соответствующие линии, идущие от
docking-разъёма:
</p>
<ul class="org-ul">
<li>Питание: <code>S_BAT_PWR_A</code>
</li>
<li>Линии интерфейса SMBus: <code>I2C_CLK_BT1</code> и <code>I2C_DATA_BT1</code>
</li>
<li>Сигнал <code>S_TEMP</code>.</li>
</ul>
<div class="figure">
<p><img src="/assets/static/bat2_schematics.png" alt="battery 1 schematics" align="center">
</p>
</div>
<p>
Эти же линии на листе с docking-разъёмом:
</p>
<div class="figure">
<p><img src="/assets/static/bat2_schematics2.png" alt="battery 1 docking connector" align="center">
</p>
</div>
<p>
К сожалению, дальнейшие изыскания пришлось прекратить. «На третий день
заточения индеец Соколиный Глаз заметил, что в сарае не хватает четвёртой
стены» — оказалось, что есть только одно место в док-станции, куда я могу
встроить батарею целиком — место, занятое платой с разъёмами. Эту плату я
убирать не хотел, место слева было занято механизмом удержания ThinkPad'а в
док-станции, место справа — корзиной под дисковод, которую я также убирать не
хотел, ибо туда можно вставить Optibay и добавить третий жёсткий диск в
систему при необходимости.
</p>
<p>
А спереди, куда можно было бы вставить батарейный отсек, вырезанный из корпуса
ThinkPad'а — был слив для воды. Естественно, что убирать его и вставлять туда
батарею — опасно, потому что вся пролитая вода потечёт прямиком на батарею.
</p>
<p>
Когда-нибудь я подумаю над проблемой встраивания аккумулятора в док-станцию,
но не сейчас…
</p>
</div>
</div>
</div>
<div id="outline-container-additional-ports" class="outline-2">
<h2 id="additional-ports">Дополнительные разъёмы и кнопочки</h2>
<div class="outline-text-2" id="text-additional-ports">
<p>
Тем не менее, можно по прежнему использовать док-станцию, чтобы всякие разъёмы
были позади ноутбука — никакие провода не помешают мне поставить кружку с чаем
сбоку от ноутбука.
</p>
<div class="figure">
<p><img src="/assets/static/rejectmodernity.jpg" alt="reject modernity embrace tradition" align="center">
</p>
</div>
<p>
Но, после установки платы 2K-модификации уже не получится просто так
подключить док-станцию к ноутбуку! Как видно из раздела «<a href="#new-display-freebsd">Новый дисплей и
FreeBSD</a>», эта плата занимает линии интерфейса Display Port и пару линий
USB. Следовательно, надо отсоединить линии Display Port от соответствующего
разъёма на стороне док-станции. И заодно проверить — не использует ли
USB-концентратор в доке те же линии, что и плата модификации.
</p>
<p>
К сожалению, я так и не нашёл в Интернете принципиальной схемы док-станции и
пришлось прозванить схему от docking connector'а. Достаточно быстро
выяснилось, что разъём Display Port на моей док-станции останется
функциональным — он использует линии <code>DOCKA_DP</code>, тогда как плата 2K-модификации
использует отдельные линии <code>DOCKB_DP</code>.
</p>
<p>
А вот линии <code>USBP8</code> увы используются. Они подходят к контроллеру USB2514B от
Microchip (чип <code>U13</code>), и использовать 4 USB2.0 порта сзади док-станции не
получится. Линии <code>USBP8</code> придётся отключить от разъёма.
</p>
<div class="figure">
<p><img src="/assets/static/dock_usb_controller.jpg" alt="usb controller on dock-station" align="center">
</p>
<p style="text-align: center"><i>USB-контроллер Microchip USB2514B (U13)</i></p>
</div>
<p>
На схеме ноутбука видно, что к разъёму для док-станции подходят ещё линии
<code>USBP12</code> (<code>DOCK_USB</code>) — по идее, можно прямо на плате док-станции перерезать линии
<code>USBP8</code> и подпаять к ним витую пару с экраном, которая другим концом будет
припаяна к контактам, идущим от линии <code>USBP12</code> — и тогда USB-порты сзади
док-станции снова будут работать. Но сделаю я эту модификацию уже как-нибудь в
другой раз.
</p>
<p>
Ещё я собирался добавить к док-станции тумблер вместо кнопки включения и
защитную крышку для тумблера. Я питаю нездоровый интерес к таким защитным
крышкам — они приятно щёлкают и чувствуется сопротивление пружины при
откидывании крышки.
</p>
<p>
К тому же, при каждом включении ноутбука ты чувствуешь себя как пилот
звездолёта из фантастических фильмов 90-х:
</p>
<div class="figure">
<p><img src="/assets/static/space_riders.jpg" alt="tumbler fantastic" align="center">
</p>
</div>
<p>
Под тумблер и защитную крышку как раз есть подходящее место в левом боку
док-станции, напротив рычага для снятия ноутбука:
</p>
<div class="figure">
<p><img src="/assets/static/tumbler_drawing.jpg" alt="tumbler drawing" align="center">
</p>
<p style="text-align: center"><i>Чертёж отверстия под тумблер</i></p>
</div>
<p>
Провода от тумблера я подпаял к разъёму, который служит для подключения
штатной кнопки включения. Можно было бы подпаяться прямо к docking
connector'у, но его контакты находятся снизу платы и там же двигаются
механические детали:
</p>
<div class="figure">
<p><img src="/assets/static/dock_tumbler_conn.jpg" alt="tumbler connection" align="center">
</p>
</div>
<p>
Заодно, как можно видеть, был убран кабель, идущий от основной платы до кнопки
для сигнализации отключения док-станции от ноутбука. Отсоединять одно от
другого во включенном состоянии я точно не буду.
</p>
<p>
Защитная крышка была просто приклеена поксиполом и в итоге получилась вот
такая конструкция:
</p>
<div class="figure">
<p><img src="/assets/static/dock_tumbler.jpg" alt="tumbler in dock station" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/tumbler.jpg" alt="new tumbler" align="center">
</p>
</div>
<div class="video-container">
<p align="center">
<video align="center" style="max-width: 80%" controls>
<source src="/assets/static/tumbler_in_action.webm" type="video/webm">
Your browser doesn't support video tag.
</source></video>
</p>
</div>
<p>
После тестового подключения уже собранной док-станции к ноутбуку, выяснилось,
что я всё же что-то пропустил — на экране периодически возникали артефакты, а
система, хоть и успешно загружалась до рабочего стола, вскоре перезапускалась
как будто бы по watchdog'у. Поскольку снова разбирать док у меня не было
никакого желания, а документации на проприетарный разъём к нему естественно не
было — я взял сгоревшую материнскую плату и стал прозванивать контакты этого
разъёма:
</p>
<div class="figure">
<p><img src="/assets/static/docking_connector_notebook.jpg" alt="docking connector pins" align="center">
</p>
<p style="text-align: center"><i>Разъём к док-станции (CN15), со снятой пылезащитной крышкой</i></p>
</div>
<p>
Признаться, это был тот ещё геморрой — штырьковые контакты, распиновка которых
мне известна, расположены с одной стороны платы, а контакты разъёма
док-станции — на другой стороне и они крайне мелкие. У меня сломались глаза на
попытке посчитать порядковый номер первого же контакта от шины
<code>DOCKB_DP</code>. Пришлось сначала заклеивать кусочком изоленты контакты слева от
«звонящегося», фотографировать часть разъёма на телефон, увеличивать фото и
считать порядковый номер контакта уже на нём.
</p>
<p>
После пары вечеров такого «развлечения» я уже знал какие пины на разъёме
относятся к линиям <code>DOCKB_DP</code>, а какие к <code>USBP8</code>:
</p>
<div class="figure">
<p><img src="/assets/static/docking_connector1.jpg" alt="docking connector pinout" align="center">
</p>
</div>
<table border="2" cellspacing="0" cellpadding="6" frame="void">
<colgroup>
<col class="org-right">
<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Номер пина</th>
<th scope="col" class="org-left">Сигнал</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">22</td>
<td class="org-left">DOCKB_DP_DDC_CLK</td>
</tr>
<tr>
<td class="org-right">23</td>
<td class="org-left">DOCKB_DP_DDC_DATA</td>
</tr>
<tr>
<td class="org-right">24</td>
<td class="org-left">DOCKB_HPD</td>
</tr>
<tr>
<td class="org-right">27</td>
<td class="org-left">DOCKB_DP_0P</td>
</tr>
<tr>
<td class="org-right">28</td>
<td class="org-left">DOCKB_DP_0N</td>
</tr>
<tr>
<td class="org-right">30</td>
<td class="org-left">DOCKB_DP_1P</td>
</tr>
<tr>
<td class="org-right">31</td>
<td class="org-left">DOCKB_DP_1N</td>
</tr>
<tr>
<td class="org-right">33</td>
<td class="org-left">DOCKB_DP_2P</td>
</tr>
<tr>
<td class="org-right">34</td>
<td class="org-left">DOCKB_DP_2N</td>
</tr>
<tr>
<td class="org-right">36</td>
<td class="org-left">DOCKB_DP_3P</td>
</tr>
<tr>
<td class="org-right">37</td>
<td class="org-left">DOCKB_DP_3N</td>
</tr>
<tr>
<td class="org-right">39</td>
<td class="org-left">DOCKB_DP_AUXP</td>
</tr>
<tr>
<td class="org-right">40</td>
<td class="org-left">DOCKB_DP_AUXN</td>
</tr>
</tbody>
</table>
<div class="figure">
<p><img src="/assets/static/docking_connector2.jpg" alt="docking connector pinout" align="center">
</p>
</div>
<table border="2" cellspacing="0" cellpadding="6" frame="void">
<colgroup>
<col class="org-right">
<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Номер пина</th>
<th scope="col" class="org-left">Сигнал</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">21</td>
<td class="org-left">USBP8+</td>
</tr>
<tr>
<td class="org-right">22</td>
<td class="org-left">USBP8-</td>
</tr>
</tbody>
</table>
<p>
И я просто заклеил пины, относящиеся к шинам <code>DOCKB_DP</code> и <code>USBP8</code>, в разъёме самой
док-станции при помощи каптоновой ленты — в итоге глитчи и перезапуски системы
на ровном месте исчезли. Разъёмы сзади: порт для зарядки, Ethernet-порт и
аудио-джек — работали. USB порты естественно уже не работали.
</p>
<div class="figure">
<p><img src="/assets/static/docking_connector3.jpg" alt="docking connector glued" align="center">
</p>
<p style="text-align: center"><i>Заклеенные пины в коннекторе док-станции</i></p>
</div>
<p>
В итоге, вайб от работы за ноутбуком после такой модификации стал именно
таким, какой я и хотел. Открывая ноутбук, ощущаешь что крышка с дисплеем это
просто крышка, а снизу большая, надёжная и тяжёлая основная часть с
клавиатурой, которую не надо придёрживать, чтобы она не отрывалась от
стола. Тактильные ощущения при включении ноутбука через тумблер тоже на
высоте, как и звуковое сопровождение этого действия. Ещё один неожиданный
плюс — за счёт того, что ноутбук теперь стал немного выше, а клавиатура
немного наклонена к пользователю — работать за ним стало немного удобнее.
</p>
<p>
Под конец я добавил к ноутбуку дополнительных разъёмов USB3.0 через Express
Card. Сначала была куплена карточка FL 1100 у китайцев — у неё было аж три
порта вместо двух и не требовался дополнительный провод для питания, как у
прочих аналогичных карточек.
</p>
<div class="figure">
<p><img src="/assets/static/fl1100.jpg" alt="fl1100 card" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/fl1100_notebook.jpg" alt="fl1100 card" align="center">
</p>
</div>
<p>
Всё работало, но карта грелась как утюг, не защёлкивалась в слоте и
отключалась после десятка минут во включенной системе:
</p>
<pre class="example">
ugen1.1: &lt;(0x1b73) XHCI root HUB&gt; at usbus1 (disconnected)
unknown: at usbus1, port 1, addr 1 (disconnected)
usbus1: detached
xhci0: Controller reset timeout.
xhci0: detached
pci2: detached
pcib2: Timed out waiting for Data Link Layer Active
</pre>
<p>
В итоге, пришлось таки воспользоваться картой ExpressCard BC398 с двумя USB3.0
портами и дополнительным разъёмом для внешнего питания от другого USB
разъёма — на случай если надо будет подключить что-то энергоёмкое, вроде
переносного жёсткого диска.
</p>
<div class="figure">
<p><img src="/assets/static/bc398.jpg" alt="bc398 card" align="center">
</p>
</div>
<p>
С этой картой уже не было никаких проблем — она фиксировалась внутри слота, не
грелась и не отваливалась после 10 минут работы.
</p>
<div class="figure">
<p><img src="/assets/static/bc398_notebook.jpg" alt="bc398 card" align="center">
</p>
</div>
</div>
</div>
<div id="outline-container-new-case" class="outline-2">
<h2 id="new-case">Прошивка нового чехла</h2>
<div class="outline-text-2" id="text-new-case">
<p>
С таким ноутбуком уже не хочется использовать обычный тряпичный чехол из
массмаркета. Да и будем честны, чехол под такую машинку уже не найдёшь — всё
что сейчас можно купить, рассчитано на современные тонкие ноутбуки.
</p>
<p>
Поскольку я умею работать с кожей — я просто сшил сам себе чехол. Для
изготовления всяких чехлов к своей технике я когда-то купил полшкуры крупного
рогатого скота — чёрного цвета и растительного дубления, чтобы её можно было
формовать и делать оттиски логотипов «просто добавив воды».
</p>
<p>
Я не использую выкройки — обычно сначала придумываю что хочу, рисуя эскизы в
блокноте:
</p>
<div class="figure">
<p><img src="/assets/static/leather_case_drawing1.webp" alt="leather case drawings" align="center">
</p>
</div>
<p>
Поскольку я привык запихивать ноутбук в рюкзак боком, он также будет
вставляться и в чехол, тумблером вниз. Чтобы ноутбук не опирался на одну лишь
защитную крышку тумблера, на дне чехла будет лежать немного поролона. Сверху
всё это будет закрываться клапаном с парой кобурных кнопок, на которые будут
накидываться два ремешка.
</p>
<p>
Сначала я хотел сделать переднюю и заднюю стенки из цельного куска кожи, чтобы
мне надо было поменьше раскраивать. Но потом <i>внезапно</i> выяснилось, что остаток
от купленной шкуры слишком маленький и вырезать из него пластину длиной в метр
с лишним — уже не выйдет. Пришлось перерисовывать чертёж и вводить две
отдельных детали для передней и задней стенок, которые будут сшиваться
«встык».
</p>
<div class="figure">
<p><img src="/assets/static/leather_case_drawing2.webp" alt="leather case drawings" align="center">
</p>
</div>
<p>
Ну а дальше я уже просто разметил детали чехла на шкуре, тщательно проверяя по
нескольку раз все размеры, и раскроил её.
</p>
<div class="figure">
<p><img src="/assets/static/measurements.jpeg" alt="measurements meme" align="center">
</p>
</div>
<p>
Происходит это примерно так же, как и в слесарном деле. Даже немного проще —
ведь кожу можно немного растянуть, если вдруг где-то ошибся на пару
миллиметров.
</p>
<p>
Из забавных лайфхаков в процессе разметки: в качестве лекала для выреза на
передней стенке прекрасно подходит обычная тарелка:
</p>
<div class="figure">
<p><img src="/assets/static/leather_case_pattern.jpg" alt="plate as pattern for case" align="center">
</p>
</div>
<p>
А для формирования полукруглых сгибов на дне и на крышке чехла — отлично
подходят две высокие банки от Dr. Pepper, смотанные вместе при помощи
скотча. По диаметру они как раз около 60 мм.
</p>
<div class="figure">
<p><img src="/assets/static/leather_case_folding.jpg" alt="folding and dr pepper" align="center">
</p>
</div>
<p>
Передняя и задняя стенки соединяются швом «крест-накрест», как описывается <a href="https://www.youtube.com/watch?v=jxWiJ20esyo">в
этом видео</a>. Ну а боковые стенки пришиваются тем же методом, который описан в
книге Al Stohlman: «The art of hand sewing leather»<sup><a id="fnr.leather_box" class="footref" href="#fn.leather_box" role="doc-backlink">9</a></sup>.
</p>
<p>
Внутри чехол должен быть обязательно устлан подкладочной тканью. Бахтарма
(«изнанка» куска кожи) является абразивной и ноутбук со временем просто
вытрется до металла, если её не закрыть. По хорошему, надо было сшить что-то
вроде мешочка по размерам внутренней части чехла, но для ускорения процесса, я
просто приклеил подкладочную ткань к изнанке соответствующих деталей.
</p>
<p>
В конечном итоге, после сшивания всех деталей вместе, полировки урезов и
установки кобурных кнопок, получился вот такой чехол:
</p>
<div class="figure">
<p><img src="/assets/static/leather_case.jpg" alt="leather case" align="center">
</p>
</div>
<p>
Ноутбук в него входит как влитой — очевидно иначе и быть не могло, если
предварительно всё было тщательно измерено и рассчитано :-).
</p>
</div>
</div>
<div id="outline-container-update-17-07-2024" class="outline-2">
<h2 id="update-17-07-2024">Апдейт за 17.07.2024</h2>
<div class="outline-text-2" id="text-update-17-07-2024">
<p>
К несчастью, дисплей помер после пары месяцев работы. После того как ноутбук
постоял включённым на солнечном свету так, что солнце светило на нижнюю
четверть задней крышки — изображение на нижней 1/4 дисплея стало выглядеть
так, будто по нему ударили острым предметом.
</p>
<p>
Предполагаю, что тут сыграло свою роль неравномерное тепловое расширение
корзины для дисплея и самого дисплея. А также, возможно то, что дисплей не
особо аккуратно доставили из Китая — посылка с ним около 20 дней лежала без
движения на складе Cainiao в Петербурге и что там с ней происходило —
неизвестно.
</p>
<p>
Перед установкой нового дисплея я модифицировав самодельную «корзину», чтобы
свести вероятность повторной поломки к минимуму:
</p>
<ul class="org-ul">
<li>просверлил <b>много</b> отверстий в оргстекле позади дисплея, чтобы там вместо
«теплицы» был нормальный теплообмен с остальным пространством в крышке
ноутбука;</li>
<li>приклеил дисплей к корзине лишь на две полоски скотча по бокам от него, а не
так <i>надёжно</i>, как было раньше — чтобы при тепловом расширении гнулась
корзина, а не матрица (а гнётся она, понятное дело, лучше чем сам дисплей).</li>
</ul>
<p>
На данный момент экран снова работает стабильно и не собирается ломаться.
</p>
</div>
</div>
<div id="outline-container-update-22-12-2024" class="outline-2">
<h2 id="update-22-12-2024">Апдейт за 22.12.2024</h2>
<div class="outline-text-2" id="text-update-22-12-2024">
<p>
Выше я писал о том, что четыре USB порта на задней стороне ноутбука не
работали — из-за того, что шина <code>USBP8</code> была занята платой расширения для нового
2K-экрана. Тем не менее, мне нужны были эти порты — хотя бы для того, чтобы по
бокам ноутбука ничего не торчало и было свободное пространство для чашки с
чаем или блокнота. И одним прекрасным вечером я таки добрался до того, чтобы
разобраться с USB.
</p>
<p>
Помимо занятой шины <code>USBP8</code>, через разъём для док-станции проходят ещё линии для
интерфейса USB — <code>DOCK_USB</code> — которые в моей версии док-станции не
используются. Вот они на блочной диаграмме, слева:
</p>
<div class="figure">
<p><img src="/assets/static/docking_block.png" alt="Block diagram of laptop" align="center">
</p>
<p style="text-align: center"><i>Блочная диаграмма Thinkpad X220</i></p>
</div>
<p>
Эта же шина на принципиальной схеме с разъёмом для дока (разъём слева):
</p>
<div class="figure">
<p><img src="/assets/static/dock_usb_schematic.png" alt="Docking connector with USB3.0 lines" align="center">
</p>
</div>
<p>
На стороне ноутбука, в зависимости от того, как выставлены перемычки на
материнской плате, эта шина идёт к:
</p>
<ul class="org-ul">
<li>Контроллеру USB2.0 — если установлены перемычки <code>R437</code> и <code>R438</code>. В этом случае всё
точно заработает.</li>
<li>Контроллеру USB3.0 — если установлены перемычки <code>R436</code> и <code>R439</code>. В этом случае
остаётся уповать на обратную совместимость.</li>
</ul>
<p>
Судя по boardview (спасибо <a href="https://mastodon.ml/@Evv1L">@Evv1L</a> за ссылку на BDV-файл), искомые перемычки
расположены на той же стороне платы, где и разъём док станции, рядом с
кулером:
</p>
<div class="figure">
<p><img src="/assets/static/boardview_usb_jumpers.png" alt="Boardview of X220 motherboard with marked jumpers for USB interface" align="center">
</p>
</div>
<div class="figure">
<p><img src="/assets/static/boardview_usb_jumpers2.png" alt="Close up view of jumpers to USB interface selection" align="center">
</p>
</div>
<p>
Вполне ожидаемо, что в случае с материнской платой, которая поддерживает
USB3.0 (если установлен Intel Core i7) — эти перемычки подключают док-станцию
к линиям USB3.0:
</p>
<div class="figure">
<p><img src="/assets/static/usb_jumpers.jpg" alt="USB selection jumpers on the motherboard, selected R436 and R439" align="center">
</p>
<p style="text-align: center"><i>Установлены перемычки R436 и R439</i></p>
</div>
<p>
Остаётся подключить эти линии к USB-хабу на плате самой док-станции. Это
минутное дело, для выполнения которого достаточно подпаять 1.5 см витой пары к
двум контактам, идущим от линий <code>DOCK_USB</code>, к двум контактам, идущим от <code>USBP8</code> к
USB-хабу от Microchip. Последние всё равно были ранее изолированы мной от
ноутбука, а так — не придётся прозванивать половину платы, чтобы найти куда
эти линии подключаются к микросхеме USB2514.
</p>
<div class="figure">
<p><img src="/assets/static/twisted_pair.jpg" alt="Soldered twisted pair to enable 4 USB ports on the docking station" align="center">
</p>
</div>
<p>
Единственное, что нужно было учесть — штыревые контакты со стороны платы на
разъёме для докстанции типа «папа» и на разъёме типа «мама» не
совпадают. Поэтому пришлось заранее прозвонить разъём на самой док-станции,
чтобы припаять концы витой пары к правильным контактам.
</p>
<p>
И в результате — порты на задней стенке бывшей док-станции успешно завелись!
</p>
</div>
</div>
<div id="outline-container-results" class="outline-2">
<h2 id="results">Итоговые результаты</h2>
<div class="outline-text-2" id="text-results">
<div class="figure">
<p><img src="/assets/static/notebook_before.jpg" alt="notebook before modifications" align="center">
</p>
<p style="text-align: center"><i>Ноутбук до всех изменений</i></p>
</div>
<div class="figure">
<p><img src="/assets/static/notebook_after.jpg" alt="notebook after modifications" align="center">
</p>
<p style="text-align: center"><i>Ноутбук после модификации</i></p>
</div>
<table border="2" cellspacing="0" cellpadding="6" frame="void">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"> </th>
<th scope="col" class="org-left">Было</th>
<th scope="col" class="org-left">Стало</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Дисплей</td>
<td class="org-left">1366x768</td>
<td class="org-left">2560x1440</td>
</tr>
<tr>
<td class="org-left">WiFi</td>
<td class="org-left">2.4 GHz, 300 Mbps, 802.11b/g/n</td>
<td class="org-left">2.4 и 5 GHz, 800-900 Mbps, 802.11b/g/n/ac, плюс встроенная поддержка Bluetooth</td>
</tr>
<tr>
<td class="org-left">Жёсткие диски</td>
<td class="org-left">180 GB SSD</td>
<td class="org-left">0.5 TB SSD и 180 GB SSD, плюс можно подключить ещё один диск через Optibay</td>
</tr>
<tr>
<td class="org-left">USB порты</td>
<td class="org-left">1xUSB3.0, 2xUSB2.0</td>
<td class="org-left">3xUSB3.0, 6xUSB2.0</td>
</tr>
<tr>
<td class="org-left">Клавиатура</td>
<td class="org-left">Оригинальная, с британской раскладкой и кириллическими наклейками</td>
<td class="org-left">Оригинальная, с американской раскладкой</td>
</tr>
<tr>
<td class="org-left">Время работы от батареи</td>
<td class="org-left">Примерно 1.5 часа</td>
<td class="org-left">5-6 часов. При использовании внешнего powerbank — до 9 часов</td>
</tr>
</tbody>
</table>
<p>
В итоге, эта машинка послужит мне ещё как минимум следующий десяток
лет. Единственное узкое место тут — всякий JavaScript с сайтов — если он
начнёт по 8 Гб на вкладку отжирать, то придётся туго.
</p>
<hr>
</div>
</div>
<div id="outline-container-notes" class="outline-2">
<h2 id="notes">Примечания</h2>
<div class="outline-text-2" id="text-notes">
</div>
</div>
<div id="footnotes">
<div id="text-footnotes">
<div class="footdef">
<sup><a id="fn.pause" class="footnum" href="#fnr.pause" role="doc-backlink">1</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
Кнопку Pause я использую, чтобы ставить на паузу приложения, грузящие
процессор на 100%, если он мне нужен для чего-то другого. Заодно и для
экономии заряда батареи — если Firefox используется через раз, то пока он мне
не нужен, он стоит на паузе. Работает это <a href="https://vermaden.wordpress.com/2018/09/19/freebsd-desktop-part-16-configuration-pause-any-application/">примерно так</a>.
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.ips_problem" class="footnum" href="#fnr.ips_problem" role="doc-backlink">2</a></sup><div class="footpara" role="doc-footnote">
<p class="footpara">
Это проблема IPS матриц, используемых в этих Thinkpad'ах —
при сильном ударе по крышке на экране появляется пятно, которое светится
немного ярче, чем окружающий экран:
</p>
<div class="figure">
<p><img src="/assets/static/ips_display_problem.jpg" alt="spots on the screen" align="center">
</p>
</div>
</div>
</div>
<div class="footdef">
<sup><a id="fn.1st_mb_fail" class="footnum" href="#fnr.1st_mb_fail" role="doc-backlink">3</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
На самом деле, первая материнская плата уже давно умирала, но
поскольку ноутбуком я пользовался аккуратно — аналогичные «симптомы»
проявлялись всего пару раз. А вмешательство во внутренности системы с
паяльником — всего лишь ускорило неизбежную кончину.
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.freebsd_coreboot_fix" class="footnum" href="#fnr.freebsd_coreboot_fix" role="doc-backlink">4</a></sup><div class="footpara" role="doc-footnote">
<p class="footpara">
В интернете <a href="https://libreboot.org/docs/bsd/#freebsd-and-corebootfb">пишут</a>, что libgfxinit с framebuffer и
установщики *BSD очень сильно не дружат. Но я нашёл способ их подружить — в
процессе загрузки, когда на экране уже напечатаны строки:
</p>
<pre class="example">
Booting from Hard Disk ...
/
</pre>
<p class="footpara">
… там на самом деле должен отображаться в текстовом режиме экран
загрузчика. В этот момент, надо вслепую нажать на <code>&lt;Esc&gt;</code> и вбить команду <code>vbe
on</code>. После этого на экране отобразится приглашение командной строки загрузчика
и уже можно спокойно загружать FreeBSD командой <code>boot</code>.
</p>
</div>
</div>
<div class="footdef">
<sup><a id="fn.display_module_disassemble" class="footnum" href="#fnr.display_module_disassemble" role="doc-backlink">5</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
Раздел «2010 LCD front bezel» (страница 88),
«2050 LCD panel and LCD cable» (страница 99), «2020 LED board» (страница 89),
«2040 Integrated camera» (страница 98) и «2070 LCD rear cover and wireless
antenna cables» (страница 102).
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.bdc" class="footnum" href="#fnr.bdc" role="doc-backlink">6</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
См «2030 Bluetooth daughter card (BDC-2.1)» на странице 91 в
сервисном мануале.
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.kbd_layouts" class="footnum" href="#fnr.kbd_layouts" role="doc-backlink">7</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
Глобально, есть две раскладки клавиатуры. Британская — где
Г-образный Enter, короткий левый Shift и есть дополнительная кнопка с
символами <code>&lt;</code>, <code>&gt;</code>, <code>\</code> слева от кнопки <code>z</code>. И американская, где вытянутый Enter и
длинный Shift.
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.bms" class="footnum" href="#fnr.bms" role="doc-backlink">8</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
Battery Management System
</p></div>
</div>
<div class="footdef">
<sup><a id="fn.leather_box" class="footnum" href="#fnr.leather_box" role="doc-backlink">9</a></sup><div class="footpara" role="doc-footnote"><p class="footpara">
Секция «Sewing a miter joint», страница 22.
</p></div>
</div>
</div>
</div>
</div>
</article>
</section>
</div>
</div>
</div>
</main><footer class="site-footer h-card">
<div class="wrapper">
<div class="site-footer-inner">
<div>
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="#586e75" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
<a href="/changelog.html">ChangeLog</a> ┆
<a href="/tags.html">Tags</a> ┆
<a href="/categories.html">Categories</a> ┆
<a href="/archives.html">Archives</a>
</div>
<br>

<div xmlns:cc="http://creativecommons.org/ns#">
<a rel="cc:attributionURL" href="https://eugene-andrienko.com/">This blog</a>
© 2020-2025 by
<a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://eugene-andrienko.com/about">Eugene Andrienko</a>
is licensed under
<a href="https://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
CC BY 4.0
</a>
<img loading="lazy" width="16" height="16" class="copyleft" src="/assets/images/icons/cc.svg" alt="CC">
<img loading="lazy" width="16" height="16" class="copyleft" src="/assets/images/icons/by.svg" alt="BY">
</div>
<div>
Powered by: <a title="Jekyll is a simple, blog-aware, static site
generator." href="https://jekyllrb.com/">Jekyll</a>.
Icons: <a href="https://github.com/feathericons/feather">Feather</a>.
Colors: <a href="https://ethanschoonover.com/solarized/">Solarized Light</a>.
</div>

<div class="old-gold-buttons">
<a href="https://eugene-andrienko.com/en/it/2024/07/07/thinkpad-x220-second-life">
<img loading="lazy" alt="IBM Thinkpad button" width="80" height="15" src="/assets/images/buttons/80x15/thinkpad.png">
</a>
<a href="https://github.com/eugeneandrienko">
<img loading="lazy" alt="Night coder button" width="80" height="15" src="/assets/images/buttons/80x15/nightcoder.png">
</a>
<img loading="lazy" alt="Love dragons button" width="80" height="15" src="/assets/images/buttons/80x15/dragon.png">
</div>
<div class="old-gold-buttons">
<a href="https://cobaltblue.neocities.org/buttons/">
<img loading="lazy" alt="Made by dragon button" width="88" height="31" src="/assets/images/buttons/88x31/dragonmade-yellow.png">
</a>
<map name="fediring6">
<area href="https://fediring.net/previous?host=eugene-andrienko.com%2Fen%2F" shape="rect" coords="3,6,12,27" target="_top" alt="previous" title="previous">
<area href="https://fediring.net/" shape="rect" coords="15,3,72,27" target="_blank" alt="Fediring" title="Fediring">
<area href="https://fediring.net/next?host=eugene-andrienko.com%2Fen%2F" shape="rect" coords="75,6,84,27" target="_top" alt="next" title="next">
</map>
<img loading="lazy" usemap="#fediring6" alt="Fediring" width="88" height="31" src="/assets/images/buttons/88x31/fediring.png">
<map name="noaimini7">
<area href="https://baccyflap.com/noai" shape="rect" coords="15,3,72,27" target="_blank" alt="no ai webring" title="no ai webring">
<area href="https://baccyflap.com/noai/?prv&s=drg" target="_top" shape="rect" coords="3,6,12,27" alt="previous" title="previous">
<area href="https://baccyflap.com/noai/?nxt&s=drg" target="_top" shape="rect" coords="75,6,84,27" alt="next" title="next">
</map>
<img loading="lazy" usemap="#noaimini7" alt="No AI ring" width="88" height="31" src="/assets/images/buttons/88x31/noaiwidget.gif">
<a href="https://512kb.club/#100">
<img loading="lazy" alt="512KB club, green team" width="88" height="31" src="/assets/images/buttons/88x31/green-team.gif">
</a>
<a href="https://no-js.club/">
<img loading="lazy" alt="no-JS Club" width="88" height="31" src="/assets/images/buttons/88x31/javascript-zero.gif">
</a>
<a href="https://www.gnu.org/software/emacs/">
<img loading="lazy" alt="Created with Emacs" width="88" height="31" src="/assets/images/buttons/88x31/emacs.gif">
</a>
</div>
</div>
</div>
</footer>
</body>
</html>
