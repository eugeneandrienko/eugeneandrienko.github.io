<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Dragon's notes - IT</title><link href="https://eugene-andrienko.com/" rel="alternate"></link><link href="https://eugene-andrienko.com/feeds/it.atom.xml" rel="self"></link><id>https://eugene-andrienko.com/</id><updated>2020-09-26T00:20:00+03:00</updated><entry><title>Настройка FreeBSD на Lenovo Thinkpad X220 (2011 года)</title><link href="https://eugene-andrienko.com/thinkpad-x220-freebsd.html" rel="alternate"></link><published>2020-09-26T00:20:00+03:00</published><updated>2020-09-26T00:20:00+03:00</updated><author><name>Eugene</name></author><id>tag:eugene-andrienko.com,2020-09-26:/thinkpad-x220-freebsd.html</id><summary type="html">Эта небольшая заметка кратко описывает настройку FreeBSD 12.1 для работы на Lenovo
ThinkPad X220 — чтобы не забыть неочевидные действия, выполняемые после
установки системы. Используемый ThinkPad из 2011 года — из тех времён, когда ещё
использовался приличный дизайн от &lt;span class="caps"&gt;IBM&lt;/span&gt; – с синим Enter и семирядной клавиатурой.</summary><content type="html">&lt;p&gt;Эта небольшая заметка кратко описывает настройку FreeBSD 12.1 для работы на Lenovo
ThinkPad X220 — чтобы не забыть неочевидные действия, выполняемые после
установки системы. Используемый ThinkPad из 2011 года — из тех времён, когда ещё
использовался приличный дизайн от &lt;span class="caps"&gt;IBM&lt;/span&gt; – с синим Enter и семирядной клавиатурой.&lt;/p&gt;
&lt;div class="contents topic" id="topic-1"&gt;
&lt;p class="topic-title"&gt;Содержание поста:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#bash" id="toc-entry-1"&gt;Корректное отображение ~ в пути, в приглашении bash&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-1" id="toc-entry-2"&gt;Минимальный набор групп для доступа к устройствам ноутбука&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-2" id="toc-entry-3"&gt;Управление питанием&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-3" id="toc-entry-4"&gt;Звук&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-4" id="toc-entry-5"&gt;Управление яркостью&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-5" id="toc-entry-6"&gt;Мультимедиа-клавиши&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-6" id="toc-entry-7"&gt;Тачпад и трекпойнт&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-7" id="toc-entry-8"&gt;Веб-камера&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-8" id="toc-entry-9"&gt;Сон&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#drm-kmod" id="toc-entry-10"&gt;Включение drm-kmod&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#wi-fi" id="toc-entry-11"&gt;Wi-Fi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#section-9" id="toc-entry-12"&gt;Разное&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;В заметке используются материалы из следующих мест:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://cyber.dabamos.de/unix/x230/"&gt;https://cyber.dabamos.de/unix/x230/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://unrelenting.technology/articles/freebsd-on-the-thinkpad-x240"&gt;https://unrelenting.technology/articles/freebsd-on-the-thinkpad-x240&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/grembo/xorg-udev-setup-check"&gt;https://github.com/grembo/xorg-udev-setup-check&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.c0ffee.net/blog/freebsd-on-a-laptop/"&gt;https://www.c0ffee.net/blog/freebsd-on-a-laptop/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://cooltrainer.org/a-freebsd-desktop-howto/"&gt;https://cooltrainer.org/a-freebsd-desktop-howto/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/title/Lenovo_ThinkPad_X230"&gt;https://wiki.archlinux.org/title/Lenovo_ThinkPad_X230&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="bash"&gt;
&lt;h2&gt;Корректное отображение ~ в пути, в приглашении bash&lt;/h2&gt;
&lt;p&gt;Поскольку все домашние каталоги пользователей расположены по пути
&lt;tt class="docutils literal"&gt;/usr/home/&lt;/tt&gt;, а &lt;tt class="docutils literal"&gt;/home/&lt;/tt&gt; лишь символическая ссылка на вышеуказанный
каталог – в приглашении командной строки &lt;tt class="docutils literal"&gt;\w&lt;/tt&gt; будет заменяться не на
&lt;tt class="docutils literal"&gt;~/catalog_name&lt;/tt&gt;, а на &lt;tt class="docutils literal"&gt;/usr/home/catalog_name&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Чтобы путь к каталогу внутри домашнего каталога имел в своём начале
&lt;tt class="docutils literal"&gt;~&lt;/tt&gt;, нужно установить в качестве домашнего каталога пользователя
прямой путь к нему — &lt;tt class="docutils literal"&gt;/usr/home/&lt;/tt&gt;, а не символическую ссылку — &lt;tt class="docutils literal"&gt;/home/&lt;/tt&gt;. Делается это
через &lt;tt class="docutils literal"&gt;sudo chsh username&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-1"&gt;
&lt;h2&gt;Минимальный набор групп для доступа к устройствам ноутбука&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;wheel — нужен для sudo;&lt;/li&gt;
&lt;li&gt;video – для доступа к &lt;tt class="docutils literal"&gt;/dev/dri/card*&lt;/tt&gt;;&lt;/li&gt;
&lt;li&gt;webcamd — для доступа к веб-камере.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2&gt;Управление питанием&lt;/h2&gt;
&lt;p&gt;Настройки для &lt;tt class="docutils literal"&gt;/etc/rc.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
powerd_enable="YES"
powerd_flags="-a hiadaptive -b adaptive -M 2000"
performance_cx_lowest="C2"
economy_cx_lowest="C3"
&lt;/pre&gt;
&lt;p&gt;В &lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt; добавить:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
cpufreq_load="YES"
kern.hz=100
&lt;/pre&gt;
&lt;p&gt;Благодаря этим настройкам ноутбук станет более медленным, но энергосберегающим
при работе от батареи. И наоборот — при работе от сети.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-3"&gt;
&lt;h2&gt;Звук&lt;/h2&gt;
&lt;p&gt;Нужно загружать модуль &lt;tt class="docutils literal"&gt;snd_hda&lt;/tt&gt; при старте системы – для этого добавляем в
&lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
snd_hda_load="YES"
&lt;/pre&gt;
&lt;p&gt;Для переключения между динамиками и наушниками нужно добавить в
&lt;tt class="docutils literal"&gt;/boot/device.hints&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hint.hdaa.0.nid20.config="as=1 seq=0 device=Speaker"
hint.hdaa.0.nid21.config="as=1 seq=15 device=Headphones"
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="section-4"&gt;
&lt;h2&gt;Управление яркостью&lt;/h2&gt;
&lt;p&gt;В &lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt; надо добавить это:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
acpi_ibm_load="YES"
acpi_video_load="YES"
&lt;/pre&gt;
&lt;p&gt;Первая строка загружает модуль ядра, который обеспечивает взаимодействие с
разной полезной периферией на Thinkpad’ах — вроде мультимедиа-клавиш, кнопок
контроля яркости и т.п.&lt;/p&gt;
&lt;p&gt;Вторая строка загружает модуль с помощью которого можно управлять яркостью
экрана через sysctl, обращаясь к &lt;tt class="docutils literal"&gt;hw.acpi.video.lcd0.brightness&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-5"&gt;
&lt;h2&gt;Мультимедиа-клавиши&lt;/h2&gt;
&lt;p&gt;Сначала надо проверить, что модуль &lt;tt class="docutils literal"&gt;acpi_ibm&lt;/tt&gt; уже загружен в системе.&lt;/p&gt;
&lt;p&gt;После этого нужно добавить в &lt;tt class="docutils literal"&gt;/etc/devd.conf&lt;/tt&gt; следующие строки, чтобы devd
научился ловить нажатия на Fn кнопки и отсылать их в наш скрипт:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
notify 10 {
    match "system" "ACPI";
    match "subsystem" "IBM";
    action "/etc/acpi_thinkpad.sh $notify";
};
&lt;/pre&gt;
&lt;p&gt;Неполное содержимое скрипта &lt;tt class="docutils literal"&gt;/etc/acpi_thinkpad.sh&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#!/bin/sh

ACPI_EVENT="$1"

case "$ACPI_EVENT" in
    '0x04')
        /usr/sbin/zzz
        ;;
esac
&lt;/pre&gt;
&lt;p&gt;Посмотреть скан-коды клавиш можно остановив devd и запустив его из
консоли от рута с ключом &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-d&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-6"&gt;
&lt;h2&gt;Тачпад и трекпойнт&lt;/h2&gt;
&lt;p&gt;Для начала надо включить поддержку Synaptics touchpad и трекпойнта в
&lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hw.psm.synaptics_support=1
hw.psm.trackpoint_support=1
&lt;/pre&gt;
&lt;p&gt;Пакет &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;xf86-input-synaptics&lt;/span&gt;&lt;/tt&gt; должен быть удалён — вместо него должен
быть установлен пакет &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;xf86-input-evdev&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Этого достаточно для работы тачпада и трекпойнта и средней кнопки над
тачпадом. Заодно будет работать и прокрутка при нажатии на среднюю кнопку.&lt;/p&gt;
&lt;p&gt;Мне удобен весьма чуствительный трекпойнт и для этого в &lt;tt class="docutils literal"&gt;/etc/systcl.conf&lt;/tt&gt;
должны быть следующие строки:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hw.psm.trackpoint.sensitivity=255
hw.psm.trackpoint.upper_plateau=125
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="section-7"&gt;
&lt;h2&gt;Веб-камера&lt;/h2&gt;
&lt;p&gt;Нужно произвести следующие изменения в следующих файлах:&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
cuse_load="YES"
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;/etc/rc.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
webcamd_enable="YES"
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;/etc/sysctl.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
kern.evdev.rcpt_mask=12
&lt;/pre&gt;
&lt;p&gt;После, добавить пользователя в группу &lt;tt class="docutils literal"&gt;webcamd&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo pw groupmod webcamd -m &amp;lt;username&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="section-8"&gt;
&lt;h2&gt;Сон&lt;/h2&gt;
&lt;p&gt;Для начала должен быть загружен модуль &lt;tt class="docutils literal"&gt;acpi_ibm&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Переход в режим сна делается командой: &lt;tt class="docutils literal"&gt;acpiconf &lt;span class="pre"&gt;-s&lt;/span&gt; 3&lt;/tt&gt; от рута. Либо
же, можно использовать команду &lt;tt class="docutils literal"&gt;zzz&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="drm-kmod"&gt;
&lt;h2&gt;Включение drm-kmod&lt;/h2&gt;
&lt;p&gt;Нужно установить пакет &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;graphics/drm-kmod&lt;/span&gt;&lt;/tt&gt;. Затем, надо включить
загрузку модуля &lt;tt class="docutils literal"&gt;i915kms.ko&lt;/tt&gt; добавлением следующей строки в
&lt;tt class="docutils literal"&gt;/etc/rc.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
kld_list="${kld_list} /boot/modules/i915kms.ko"
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="wi-fi"&gt;
&lt;h2&gt;Wi-Fi&lt;/h2&gt;
&lt;p&gt;Нужно добавить в &lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if_iwn_load="YES"
wlan_wep_load="YES"
wlan_ccmp_load="YES"
wlan_tkip_load="YES"
&lt;/pre&gt;
&lt;p&gt;Потом, добавить в &lt;tt class="docutils literal"&gt;/etc/rc.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
wlans_iwn0="wlan0"
ifconfig_wlan0="WPA DHCP powersave"
create_args_wlan0="country RU regdomain NONE"
&lt;/pre&gt;
&lt;p&gt;Для работы с WiFi-сетями нужно установить пакет wpa_supplicant и добавить в
начало &lt;tt class="docutils literal"&gt;/etc/wpa_supplicant.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ctrl_interface=/var/run/wpa_supplicant
eapol_version=2
fast_reauth=1
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="section-9"&gt;
&lt;h2&gt;Разное&lt;/h2&gt;
&lt;p&gt;Можно добавить в &lt;tt class="docutils literal"&gt;/boot/loader.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
autoboot_delay="2"
kern.maxproc="100000"
kern.ipc.shmseg="1024"
kern.ipc.shmmni="1024"
cpuctl_load="YES"
coretemp_load="YES"
libiconv_load="YES"
libmchain_load="YES"
cd9660_iconv_load="YES"
msdosfs_iconv_load="YES"
&lt;/pre&gt;
&lt;p&gt;Это включит поддержку температурных сенсоров в системе, сделает задержку в две
секунды перед загрузкой системы загрузчиком — чтобы долго не ждать — и так далее.&lt;/p&gt;
&lt;p&gt;Чтобы при загрузке системы &lt;span class="caps"&gt;DHCP&lt;/span&gt; client не тормозил весь процесс — можно внести в
&lt;tt class="docutils literal"&gt;/etc/rc.conf&lt;/tt&gt; следующую строку:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
background_dhclient="YES"
&lt;/pre&gt;
&lt;p&gt;Для монтирования разделов вручную пользователем, отключения системного динамика
и т.п. — можно добавить в &lt;tt class="docutils literal"&gt;/etc/sysctl.conf&lt;/tt&gt; следующее:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
vfs.read_max=128
vfs.usermount=1
hw.syscons.bell=0
kern.vt.enable_bell=0
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="IT"></category></entry></feed>