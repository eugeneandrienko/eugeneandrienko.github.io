---
layout: post
title: Plain text accounting
category: it
date: 2023-12-20
lang: en
comments: true
hidden:
  - related_posts
summary: Personal budget with «envelopes» method, hledger, sed, awk и sqlite.
---

<p>
Long time ago, since I'm got my first job, I have maintained a personal
budget. I need to understand how much I spent, for which budget items I spent
my money and so on. Also, it is very pleasant to look on numbers with my
income (and, not so pleasant — to look at my expenses).
</p>

<div class="outline-2">
<h2>Pen and notepad</h2>
<div class="outline-text-2">
<p>
At first, I used a fountain pen and a simple notepad to write down planned
expenses and planned remainder. Budget items were determined by themselves; I
didn't think about them for a long time:
</p>
<ul class="org-ul">
<li><b>communications</b>: Internet and mobile phone</li>
<li><b>food</b></li>
<li><b>leisure</b>: here is everything I take break from — from cinema and restaurants
to buying thermal paste</li>
<li><b>household</b>: usually there are different household chemicals</li>
<li><b>rent</b>: flat rent</li>
<li><b>health</b>: pharmacies, doctor visit and another «entertainments» for those over
30</li>
<li><b>transport</b>: buses, metro, taxi</li>
<li>and so on.</li>
</ul>

<pre class="example">
|----------------+------------------+-------------------|
| Budget item    | Planned expenses | Planned remainder |
|----------------+------------------+-------------------|
| Communications |              500 |             13000 |
| Food           |            10000 |              3000 |
| Household      |             2000 |              1000 |
| Transport      |             1000 |                 0 |
|----------------+------------------+-------------------|
</pre>

<p>
As you can see, I'm using «envelopes» method for expenses planning. But I have
virtual envelopes — there are budget items in the table.
</p>

<p>
Quite quickly, I realized that I also need to write down numbers with real
expenses in this table. In real life, it rarely happens what you spend the
same amount of money on <i>health</i> or <i>food</i> as you planned — and then you sit and
wonder why your budget item went into the red.
</p>


<div class="figure">
<p><img src="/assets/static/paper_budget.jpg" alt="paper_budget.jpg" />
</p>
</div>

<p>
I calculated these expenses manually at the end of every two week. Just sit
down with calculator and opened list of expenses in the Internet bank.
</p>
</div>
</div>

<div class="outline-2">
<h2>Emacs and Org Mode</h2>
<div class="outline-text-2">
<p>
After a couple of years, I got tired of counting expenses with a
calculator. In addition, I also wanted to see the real balance of budget
items, updated in real time, not every two weeks. And the total balance of
funds, calculated with data from table. With this data, I can control the
correctness of the entered expenses.
</p>

<p>
To do this, I needed some kind of table processor, not just notepad with
pen. Because I like to use console and Emacs — I turned my attention to <a href="https://orgmode.org/">Org
Mode</a>. With this I can make tables and use formulas — both spreadsheet
formulas and Emacs Lisp formulas.
</p>

<p>
After reading the manuals, I write these tables for my two-week budget:
</p>
<div class="org-src-container">
<pre class="src src-org"><span style="color: #93a1a1; font-style: italic;">#+NAME: incoming</span>
<span style="color: #859900;">|---+----------------+--------|</span>
<span style="color: #859900;">|   | Incoming       | Amount |</span>
<span style="color: #859900;">|---+----------------+--------|</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Salary         |   7000 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Past food      |    900 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Past household |    289 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Past transport |    170 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Past health    |    322 |</span>
<span style="color: #859900;">|   | All:           |   8681 |</span>
<span style="color: #859900;">|</span><span style="color: #b58900;"> ^ |                |    all </span><span style="color: #859900;">|</span>
<span style="color: #859900;">|---+----------------+--------|</span>
<span style="color: #93a1a1; font-style: italic;">#+TBLFM: $all=vsum(@2$3..@&gt;&gt;&gt;$3)</span>

<span style="color: #93a1a1; font-style: italic;">#+NAME: budget</span>
<span style="color: #859900;">|---+---------------+----------+-----------+---------------+----------------|</span>
<span style="color: #859900;">|   | Expenditure   | Spending | Remainder | Real spending | Real remainder |</span>
<span style="color: #859900;">|---+---------------+----------+-----------+---------------+----------------|</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | HCS           |     1000 |      7681 |               |           1000 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Rent          |     2000 |      5681 |               |           2000 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Communication |      600 |      5081 |               |            600 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Food          |     2590 |      2491 |           374 |           2216 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Household     |      400 |      2091 |           100 |            300 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Leisure       |     1000 |      1091 |           449 |            551 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Transport     |      500 |       591 |            80 |            420 |</span>
<span style="color: #859900;">| </span><span style="color: #b58900;">#</span><span style="color: #859900;"> | Health        |      591 |         0 |           100 |            491 |</span>
<span style="color: #859900;">|---+---------------+----------+-----------+---------------+----------------|</span>
<span style="color: #859900;">|   |               |          |         0 |      Overall: |           7578 |</span>
<span style="color: #859900;">|</span><span style="color: #b58900;"> ^ |               |          |         0 |               |        overall </span><span style="color: #859900;">|</span>
<span style="color: #859900;">|---+---------------+----------+-----------+---------------+----------------|</span>
<span style="color: #93a1a1; font-style: italic;">#+TBLFM: $6=$3-$5::@2$4=remote(incoming, $all)-@2$3::@3$4..@&gt;$4=@-1$4-@0$3::$overall=vsum(@II..III$6)</span>
</pre>
</div>

<p>
Also, there are two manually filled tables — first with savings data and
second with expenses statistics per month.
</p>

<p>
It works as follows. Income data was entered to the table named <code>incoming</code> and
their sum automatically calculated in the <code>all</code> cell. Based on this sum, the
planned balance for budget items was calculated. Also, the real account
balance in the <code>overall</code> cell from <code>budget</code> table was calculated too.
</p>

<p>
For some time, this automation suited me. I just look at the expenses in
notifications from the bank, sum the numbers for the desired category and
update the corresponding cell with expenses in the table.
</p>

<p>
But there were also some inconveniences that I would still like to
automate. First, sometimes I forgot to enter (or sum) expenses, causing the
numbers in the corresponding row of the table to diverge from reality. Due to
the fact that data for each transaction was not saved here, it was difficult
to correct such errors and I had to "guess" what and where I forgot.
</p>

<p>
Secondly, it was difficult to keep statistics on expenses by month — every two
weeks, I should manually sum the amounts and update the data in the table of
expenses by month. The same goes for savings. Moreover, there was no adequate
access to tables for previous months — there was no Org Mode machine-friendly
interface for working with archived tables. Except that write many and many
really complex regular expressions which will parse dates and data.
</p>
</div>
</div>

<div class="outline-2">
<h2>Hledger and SQL-scripts</h2>
<div class="outline-text-2">
<p>
At this point, I thought about budgeting in some simpler way. I had already
heard something about <a href="https://plaintextaccounting.org/">plain-text accounting</a> and read <a href="https://vas3k.club/post/15073/">post about it</a> in
Vas3k.Club.
</p>

<p>
The ledger didn't work out for the first time — the manuals and HOWTOs were
overcomplicated with examples of processing credit accounts, stock accounts,
debts and so on. I'm almost never used all of these in my life (I'm living in
one of CIS countires and usually we do not have enough money to use credits or
stocks like financial instruments here). Also, all of the guides assumed that
I was budgeting on a rolling basis — without two-week periods, like I do. This
make difficult to translate my spreadsheets into a continuous list of
expenses. Also, it was not at all obvious how to adapt «money envelopes»
system for ledger.
</p>

<p>
Luckily, I came across <a href="https://hledger.org/">hledger</a> and understood the principles of how it
works. It turned out to be quite simple. Hledger is not a "silver bullet" that
automatically calculates all the necessary things for you. It is like a small
database, that allows you to <code>SELECT</code> data from financial transactions, filter
them by account name or by date. And with a nice ability to convert from one
currency to another "on the fly".
</p>

<p>
Everything else builds on top of this functionality.
</p>


<div class="figure">
<p><img src="/assets/static/main_ledger_window.png" alt="main_ledger_window.png" />
</p>
</div>
</div>

<div class="outline-3">
<h3>"Money envelopes" in the hledger</h3>
<div class="outline-text-3">
<p>
To make the "money envelope" technique work in hledger, I had to work
hard. Fortunately, there were people, who were already using it and who knew
plain-text accounting. I took the main idea from <a href="https://github.com/simonmichael/hledger/blob/master/examples/budgeting/envelope-budget-auto-1.journal">here</a>.
</p>

<p>
First I described all my expense accounts:
</p>
<div class="org-src-container">
<pre class="src src-ledger">account expenses                ; type: X
account expenses:hcs            ; type: X
account expenses:rent           ; type: X
account expenses:communication  ; type: X
account expenses:food           ; type: X
account expenses:household      ; type: X
account expenses:leisure        ; type: X
account expenses:transport      ; type: X
account expenses:psychotherapy  ; type: X
account expenses:health         ; type: X
</pre>
</div>

<p>
And the main account from which the money is debited: <code>main account:rub</code>. At
this stage, everything working according to the manual — we just write how
much money went into the expense account and how much money left the main
account.
</p>

<p>
Trying to add separate accounts for budgeting — broke the whole system for me,
<code>hledger balance</code> showed some numbers in the report which are disconnected from
the real life.
</p>

<p>
Fortunately, <a href="https://hledger.org/1.32/hledger.html#virtual-postings">virtual postings</a> saved me. They, and the rules on binding
expenses and virtual accounts — helped to avoid strange numbers in the
report. And a necessity to specify budget accounts for each transaction.
</p>
<div class="org-src-container">
<pre class="src src-ledger">account budget:hcs            ; type: X
account budget:rent           ; type: X
account budget:communication  ; type: X
account budget:food           ; type: X
account budget:household      ; type: X
account budget:leisure        ; type: X
account budget:transport      ; type: X
account budget:psychotherapy  ; type: X
account budget:health         ; type: X

= ^expenses:hcs
    (budget:hcs)                *-1
= ^expenses:rent
    (budget:rent)               *-1
= ^expenses:communication
    (budget:communication)      *-1
= ^expenses:food
    (budget:food)               *-1
= ^expenses:household
    (budget:household)          *-1
= ^expenses:leisure
    (budget:leisure)            *-1
= ^expenses:transport
    (budget:transport)          *-1
= ^expenses:psychotherapy
    (budget:psychotherapy)      *-1
= ^expenses:health
    (budget:health)             *-1
</pre>
</div>

<p>
Another difficulties were that every two weeks I fill the new budget and
create the new envelopers. Also, I have a lot of archive data from Org Mode,
where there is no 100% convergence of the budget — because transfers to
savings are not reflected anywhere. And calculating them was difficult and
tedious. Even if I calculate them, then hledger's report would again show
unrelated to reality numbers.
</p>

<p>
I got rid of the weird numbers using the <code>-b YYYY-MM-DD</code> and <code>-e YYYY-MM-DD</code> keys,
with which hledger only looks at data for a few weeks of the budget
iteration. So that it doesn’t get confused about income, savings and expenses
at the beginning of each budget period, I use a special script to add
explicitly specified savings amounts and planned expenses for new budget
period to the file:
</p>
<div class="org-src-container">
<pre class="src src-ledger">2023-12-14 "" | Balancing
    savings:touching     340.08 RUB
    savings:emergency    793.29 RUB
    savings:investments  0 RUB
    savings:foreign     $1
    savings:foreign      1 EUR
    equity:fix

2023-12-14 "" | Salary
    income:paycheck:job       -6000 RUB
    income:from past          -1489 RUB
    main account:rub

2023-12-14 "" | Budgeting
    (budget:hcs)            500 RUB
    (budget:rent)           2000 RUB
    (budget:food)           2500 RUB
    (budget:communication)  600 RUB
    (budget:household)      1000 RUB
    (budget:leisure)        1000 RUB
    (budget:transport)      500 RUB
    (budget:psychotherapy)  1000 RUB
    (budget:health)         1000 RUB
</pre>
</div>

<p>
The report should include all budget and expense accounts, even if I haven’t
spent anything in a couple of weeks. So, I should to add transactions with
zero amounts:
</p>
<div class="org-src-container">
<pre class="src src-ledger">2023-12-14 HCS
    expenses:hcs        0 RUB
    main account:rub    0 RUB

2023-12-14 Rent
    expenses:rent       0 RUB
    main account:rub    0 RUB

2023-12-14 Communication
    expenses:communication    0 RUB
    main account:rub          0 RUB

2023-12-14 Food
    expenses:food       0 RUB
    main account:rub    0 RUB

2023-12-14 Household
    expenses:household    0 RUB
    main account:rub      0 RUB

2023-12-14 Leisure
    expenses:leisure      0 RUB
    main account:rub      0 RUB

2023-12-14 Transport
    expenses:transport    0 RUB
    main account:rub      0 RUB

2023-12-14 Psychotherapy
    expenses:psychotherapy    0 RUB
    main account:rub          0 RUB

2023-12-14 Health
    expenses:health     0 RUB
    main account:rub    0 RUB
</pre>
</div>
</div>
</div>

<div class="outline-3">
<h3>Roubles exchange</h3>
<div class="outline-text-3">
<p>
I have some accounts in different currencies, which makes processing the data
more difficult. Hledger can help here — it can convert amounts from dollars
and euros to roubles. Just use parameter <code>=--value=then,RUB</code>, for example:
</p>
<div class="org-src-container">
<pre class="src src-bash">hledger -s --value=then,RUB reg -M -E -O csv <span style="color: #2aa198;">'expenses'</span>
</pre>
</div>

<p>
A separate exchange rate file must be attached to the data file. This is a
simple text file that looks like this:
</p>
<div class="org-src-container">
<pre class="src src-ledger">P 2023-12-12 $ 90.9846 RUB
P 2023-12-12 EUR 98.0769 RUB
P 2023-12-14 $ 89.8926 RUB
P 2023-12-14 EUR 96.9500 RUB
P 2023-12-15 $ 89.6741 RUB
P 2023-12-15 EUR 97.7377 RUB
P 2023-12-16 $ 89.6966 RUB
P 2023-12-16 EUR 98.4186 RUB
</pre>
</div>

<p>
Of course, you don't have to fill it in manually — there are bash, curl and
xsltproc for that. Exchange rates can be obtained from the website of the
Central Bank of the Russian Federation, as they provide usable
XML<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>. For example, to get the dollar exchange rate for the
<code>2022-12-12</code> date, you need to run the query:
<a href="https://cbr.ru/scripts/XML_dynamic.asp?date_req1=12/12/2023&amp;date_req2=12/12/2023&amp;VAL_NM_RQ=R01235">https://cbr.ru/scripts/XML_dynamic.asp?date_req1=12/12/2023&amp;date_req2=12/12/2023&amp;VAL_NM_RQ=R01235</a>. The
following XML will be returned in response:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #268bd2;">ValCurs</span> <span style="color: #268bd2;">ID</span>=<span style="color: #2aa198;">"R01235"</span> <span style="color: #268bd2;">DateRange1</span>=<span style="color: #2aa198;">"12.12.2023"</span> <span style="color: #268bd2;">DateRange2</span>=<span style="color: #2aa198;">"12.12.2023"</span> <span style="color: #268bd2;">name</span>=<span style="color: #2aa198;">"Foreign Currency Market Dynamic"</span>&gt;
    &lt;<span style="color: #268bd2;">Record</span> <span style="color: #268bd2;">Date</span>=<span style="color: #2aa198;">"12.12.2023"</span> <span style="color: #268bd2;">Id</span>=<span style="color: #2aa198;">"R01235"</span>&gt;
        &lt;<span style="color: #268bd2;">Nominal</span>&gt;1&lt;/<span style="color: #268bd2;">Nominal</span>&gt;
        &lt;<span style="color: #268bd2;">Value</span>&gt;90,9846&lt;/<span style="color: #268bd2;">Value</span>&gt;
        &lt;<span style="color: #268bd2;">VunitRate</span>&gt;90,9846&lt;/<span style="color: #268bd2;">VunitRate</span>&gt;
    &lt;/<span style="color: #268bd2;">Record</span>&gt;
&lt;/<span style="color: #268bd2;">ValCurs</span>&gt;
</pre>
</div>

<p>
You can extract data from the necessary node using xsltproc and this XSLT:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">stylesheet</span> <span style="color: #657b83; font-weight: bold;">xmlns</span>:<span style="color: #268bd2;">xsl</span>=<span style="color: #2aa198;">"http://www.w3.org/1999/XSL/Transform"</span> <span style="color: #268bd2;">version</span>=<span style="color: #2aa198;">"1.0"</span>&gt;
  &lt;<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">output</span> <span style="color: #268bd2;">method</span>=<span style="color: #2aa198;">"text"</span>/&gt;
  &lt;<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">template</span> <span style="color: #268bd2;">match</span>=<span style="color: #2aa198;">"ValCurs"</span>&gt;
    &lt;<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">for-each</span> <span style="color: #268bd2;">select</span>=<span style="color: #2aa198;">"Record"</span>&gt;
      &lt;<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">value-of</span> <span style="color: #268bd2;">select</span>=<span style="color: #2aa198;">"Value"</span>/&gt;
    &lt;/<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">for-each</span>&gt;
  &lt;/<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">template</span>&gt;
&lt;/<span style="color: #657b83; font-weight: bold;">xsl</span>:<span style="color: #268bd2;">stylesheet</span>&gt;
</pre>
</div>

<p>
A bash script puts it all together:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">!/usr/bin/</span><span style="color: #859900; font-weight: bold;">env</span><span style="color: #93a1a1;"> bash</span>

<span style="color: #657b83; font-weight: bold;">declare</span> -A <span style="color: #268bd2;">CURRENCY_CODES</span>=([<span style="color: #2aa198;">"$"</span>]=<span style="color: #2aa198;">"R01235"</span> [<span style="color: #2aa198;">"EUR"</span>]=<span style="color: #2aa198;">"R01239"</span>)
<span style="color: #268bd2;">CBR_DATE</span>=$(date <span style="color: #2aa198;">'+%d/%m/%Y'</span>)
<span style="color: #268bd2;">CBR_XSLT</span>=$(mktemp /tmp/cbr.XXXXXX.xslt)

<span style="color: #268bd2;">JOURNAL</span>=<span style="color: #2aa198;">"$HOME/path/to/exchange_rates.journal"</span>
<span style="color: #268bd2;">JOURNAL_DATE</span>=$(date <span style="color: #2aa198;">'+%Y-%m-%d'</span>)

cat &lt;&lt; EOF &gt; <span style="color: #2aa198;">"$CBR_XSLT"</span>
<span style="color: #b58900; font-weight: bold;">&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"&gt;</span>
<span style="color: #b58900; font-weight: bold;">  &lt;xsl:output method="text"/&gt;</span>
<span style="color: #b58900; font-weight: bold;">  &lt;xsl:template match="ValCurs"&gt;</span>
<span style="color: #b58900; font-weight: bold;">    &lt;xsl:for-each select="Record"&gt;</span>
<span style="color: #b58900; font-weight: bold;">      &lt;xsl:value-of select="Value"/&gt;</span>
<span style="color: #b58900; font-weight: bold;">    &lt;/xsl:for-each&gt;</span>
<span style="color: #b58900; font-weight: bold;">  &lt;/xsl:template&gt;</span>
<span style="color: #b58900; font-weight: bold;">&lt;/xsl:stylesheet&gt;</span>
<span style="color: #b58900; font-weight: bold;">EOF</span>

<span style="color: #859900; font-weight: bold;">for</span> curr<span style="color: #859900; font-weight: bold;"> in</span> <span style="color: #2aa198;">"${!CURRENCY_CODES[@]}"</span>; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">URL</span>=<span style="color: #2aa198;">"https://cbr.ru/scripts/XML_dynamic.asp?date_req1=$CBR_DATE&amp;date_req2=$CBR_DATE&amp;VAL_NM_RQ=${CURRENCY_CODES[$curr]}"</span>
    <span style="color: #268bd2;">EXCHANGE_RATE</span>=$(curl -s <span style="color: #2aa198;">"$URL"</span> | xsltproc <span style="color: #2aa198;">"$CBR_XSLT"</span> - | sed <span style="color: #2aa198;">'s/,/./g'</span>)
    <span style="color: #859900; font-weight: bold;">if</span> [ <span style="color: #b58900; font-weight: bold;">!</span> -n <span style="color: #2aa198;">"$EXCHANGE_RATE"</span> ]; <span style="color: #859900; font-weight: bold;">then</span>
        <span style="color: #859900; font-weight: bold;">continue</span>
    <span style="color: #859900; font-weight: bold;">fi</span>
    <span style="color: #657b83; font-weight: bold;">echo</span> <span style="color: #2aa198;">"P $JOURNAL_DATE $curr $EXCHANGE_RATE RUB"</span> &gt;&gt; <span style="color: #2aa198;">"$JOURNAL"</span>
<span style="color: #859900; font-weight: bold;">done</span>

rm -f <span style="color: #2aa198;">"$CBR_XSLT"</span>
</pre>
</div>

<p>
This script is run as cron job every day. As a result, I always have fresh
exchange rates every day!
</p>
</div>
</div>

<div class="outline-3">
<h3>Spending statistics for each month</h3>
<div class="outline-text-3">

<div class="figure">
<p><img src="/assets/static/expenses.png" alt="expenses.png" />
</p>
</div>

<p>
Now comes the fun part — extending hledger's capabilities.
</p>

<p>
Hledger can export its reports to CSV and SQLite can parse this CSV into
tables in an in-memory database. This makes further processing of the whole
data much easier, as SQL offers more possibilities than hledger.
</p>

<p>
I quickly found that I could get the expenses by month with the following
command:
</p>
<div class="org-src-container">
<pre class="src src-bash">hledger -s --value=then,RUB reg -M -E -O csv <span style="color: #2aa198;">'expenses'</span>
</pre>
</div>

<p>
The file path does not need to be specified if it is already set in the
<code>LEDGER_FILE</code> environment variable.
</p>

<p>
But the output of this command (even if you remove <code>-O csv</code>) is not very
readable:
</p>
<pre class="example">
"txnidx","date","code","description","account","amount","total"
...
"0","2023-11-01","","","expenses:leisure","432.00 RUB","1437564.28 RUB"
"0","2023-11-01","","","expenses:psychotherapy","998.00 RUB","1454562.28 RUB"
"0","2023-11-01","","","expenses:transport","57.00 RUB","1480019.28 RUB"
"0","2023-12-01","","","expenses:leisure","0","1481009.28 RUB"
"0","2023-12-01","","","expenses:psychotherapy","237.96 RUB","1503697.24 RUB"
"0","2023-12-01","","","expenses:transport","0","1503697.24 RUB"
...
</pre>

<p>
It is also not suitable for SQLite — no quotes are needed. And there are only
three columns for further calculations — date, account and amount. The suffix
<code>RUB</code> is not needed either — <b>all</b> amounts are already in rubles. Fortunately, the
magic of AWK comes to the rescue:
</p>
<div class="org-src-container">
<pre class="src src-bash">awk <span style="color: #2aa198;">'BEGIN {FS=","; OFS=","}</span>
<span style="color: #2aa198;">{</span>
<span style="color: #2aa198;">    gsub(/"/, "", $0);</span>
<span style="color: #2aa198;">    gsub(" RUB", "", $0);</span>
<span style="color: #2aa198;">    print $2, $5, $6;</span>
<span style="color: #2aa198;">}'</span>
</pre>
</div>

<p>
As a result, hledger output becomes:
</p>
<pre class="example">
date,account,amount
...
2023-11-01,expenses:leisure,432.00
2023-11-01,expenses:psychotherapy,998.00
2023-11-01,expenses:transport,57.00
2023-12-01,expenses:leisure,0
2023-12-01,expenses:psychotherapy,237.96
2023-12-01,expenses:transport,0
...
</pre>

<p>
This CSV can already be fed into sqlite3 for further processing the resulting
table <code>expenses</code> with SQL:
</p>
<div class="org-src-container">
<pre class="src src-bash">sqlite3 -header -csv <span style="color: #2aa198;">':memory:'</span> <span style="color: #2aa198;">'.import --csv /dev/stdin expenses'</span> <span style="color: #2aa198;">"</span>
</pre>
</div>

<p>
Here, after the double quote, is the SQL that converts the raw data from the
table <code>expenses</code> into the table I need:
</p>
<ol class="org-ol">
<li><p>
First, I sort the <code>expenses</code> table by date and by expense item, so that the
entries in the table were <b>exactly</b> in right order:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900; font-weight: bold;">WITH</span> ordered_expenses <span style="color: #859900; font-weight: bold;">AS</span> (
    <span style="color: #859900; font-weight: bold;">SELECT</span> * <span style="color: #859900; font-weight: bold;">FROM</span> expenses
    <span style="color: #859900; font-weight: bold;">ORDER</span> <span style="color: #859900; font-weight: bold;">BY</span> <span style="color: #b58900;">date</span>, account),
</pre>
</div>

<pre class="example">
+------------+------------------------+--------+
|    date    |        account         | amount |
+------------+------------------------+--------+
| 2023-11-01 | expenses:leisure       | 432.00 |
| 2023-11-01 | expenses:psychotherapy | 998.00 |
| 2023-11-01 | expenses:transport     | 57.00  |
| 2023-12-01 | expenses:leisure       | 0      |
| 2023-12-01 | expenses:psychotherapy | 237.96 |
| 2023-12-01 | expenses:transport     | 0      |
+------------+------------------------+--------+
</pre></li>
<li><p>
Then I use the window function so that the account names go along the
X-axis and the dates stay on Y-axis. Something like that:
</p>
<pre class="example">
|------------+---------+-----------+-----|
|       date | leisure | transport | hcs |
|------------+---------+-----------+-----|
| 2023-11-01 |         |           |     |
| 2023-12-01 |         |           |     |
|------------+---------+-----------+-----|
</pre>

<p>
The following query creates a table that is sequentially populated with
expenses data:
</p>
<div class="org-src-container">
<pre class="src src-sql">expenses4gnuplot <span style="color: #859900; font-weight: bold;">AS</span> (
<span style="color: #859900; font-weight: bold;">SELECT</span> <span style="color: #b58900;">date</span>,                                           <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">Reversed alphanumeric sorting here:</span>
    lag(amount, 0) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> transport,     <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:transport</span>
    lag(amount, 1) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> rent,          <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:rent</span>
    lag(amount, 2) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> psychotherapy, <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:psychotherapy</span>
    lag(amount, 3) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> leisure,       <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:leisure</span>
    lag(amount, 4) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> household,     <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:household</span>
    lag(amount, 5) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> health,        <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:health</span>
    lag(amount, 6) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> hcs,           <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:hcs</span>
    lag(amount, 7) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> food,          <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:food</span>
    lag(amount, 8) OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> communication, <span style="color: #93a1a1;">-- </span><span style="color: #93a1a1;">expenses:communication</span>
    row_number() OVER expenses_win <span style="color: #859900; font-weight: bold;">AS</span> rownumber
<span style="color: #859900; font-weight: bold;">FROM</span> ordered_expenses
WINDOW expenses_win <span style="color: #859900; font-weight: bold;">AS</span>(PARTITION <span style="color: #859900; font-weight: bold;">BY</span> <span style="color: #b58900;">date</span>)
<span style="color: #859900; font-weight: bold;">ORDER</span> <span style="color: #859900; font-weight: bold;">BY</span> <span style="color: #b58900;">date</span>, account, rownumber),
</pre>
</div>

<p>
Result looks like this:
</p>
<pre class="example">
+------------+-----------+---------------+---------+-----------+
|    date    | transport | psychotherapy | leisure | rownumber |
+------------+-----------+---------------+---------+-----------+
| 2023-11-01 | 432.00    |               |         | 1         |
| 2023-11-01 | 998.00    | 432.00        |         | 2         |
| 2023-11-01 | 57.00     | 998.00        | 432.00  | 3         |
| 2023-12-01 | 0         |               |         | 1         |
| 2023-12-01 | 237.96    | 0             |         | 2         |
| 2023-12-01 | 0         | 237.96        | 0       | 3         |
+------------+-----------+---------------+---------+-----------+
</pre></li>
<li><p>
Obviously, I only need rows where <code>rownumber</code> can be divided to 3. To select
them — I store the dates and the corresponding maximum <code>rownumber</code> in a
separate table <code>last</code>. It is clear that the list of expenditure items for
each month must match, otherwise everything will break. For that I'm enter
an expense of 0 rubles for each budget iteration every two weeks.
</p>

<p>
Query for <code>last</code> table:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900; font-weight: bold;">last</span> <span style="color: #859900; font-weight: bold;">AS</span> (
<span style="color: #859900; font-weight: bold;">SELECT</span> <span style="color: #b58900;">date</span>,
    <span style="color: #657b83; font-weight: bold;">max</span>(rownumber) <span style="color: #859900; font-weight: bold;">AS</span> maxrownumber
<span style="color: #859900; font-weight: bold;">FROM</span> expenses4gnuplot <span style="color: #859900; font-weight: bold;">GROUP</span> <span style="color: #859900; font-weight: bold;">BY</span> <span style="color: #b58900;">date</span>)
</pre>
</div>

<pre class="example">
+------------+--------------+
|    date    | maxrownumber |
+------------+--------------+
| 2023-11-01 | 3            |
| 2023-12-01 | 3            |
+------------+--------------+
</pre></li>
<li><p>
Finally, I can merge the <code>expenses</code> and the <code>last</code> tables. If use sqlite3
option <code>=--table</code> instead of <code>--csv</code>, then I get this nice table:
</p>
<pre class="example">
+------------+---------+---------------+-----------+
|    Date    | Leisure | Psychotherapy | Transport |
+------------+---------+---------------+-----------+
| 2023-11-01 | 432.00  | 998.00        | 57.00     |
| 2023-12-01 | 0       | 237.96        | 0         |
+------------+---------+---------------+-----------+
</pre>

<p>
With the next SQL-query:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #859900; font-weight: bold;">SELECT</span> e4g.<span style="color: #b58900;">date</span> <span style="color: #859900; font-weight: bold;">AS</span> <span style="color: #b58900;">Date</span>,
    e4g.communication <span style="color: #859900; font-weight: bold;">AS</span> Communication,
    e4g.food <span style="color: #859900; font-weight: bold;">AS</span> Food,
    e4g.hcs <span style="color: #859900; font-weight: bold;">AS</span> HCS,
    e4g.health <span style="color: #859900; font-weight: bold;">AS</span> Health,
    e4g.household <span style="color: #859900; font-weight: bold;">AS</span> Household,
    e4g.leisure <span style="color: #859900; font-weight: bold;">AS</span> Leisure,
    e4g.psychotherapy <span style="color: #859900; font-weight: bold;">AS</span> Psychotherapy,
    e4g.rent <span style="color: #859900; font-weight: bold;">AS</span> Rent,
    e4g.transport <span style="color: #859900; font-weight: bold;">AS</span> Transport
<span style="color: #859900; font-weight: bold;">FROM</span> expenses4gnuplot <span style="color: #859900; font-weight: bold;">AS</span> e4g
<span style="color: #859900; font-weight: bold;">JOIN</span> <span style="color: #859900; font-weight: bold;">last</span> <span style="color: #859900; font-weight: bold;">ON</span> e4g.<span style="color: #b58900;">date</span> = <span style="color: #859900; font-weight: bold;">last</span>.<span style="color: #b58900;">date</span> <span style="color: #859900; font-weight: bold;">AND</span> e4g.rownumber = <span style="color: #859900; font-weight: bold;">last</span>.maxrownumber
<span style="color: #859900; font-weight: bold;">ORDER</span> <span style="color: #859900; font-weight: bold;">BY</span> e4g.<span style="color: #b58900;">date</span>;
</pre>
</div></li>
</ol>
</div>
</div>

<div class="outline-3">
<h3>Savings data</h3>
<div class="outline-text-3">

<div class="figure">
<p><img src="/assets/static/savings.png" alt="savings.png" />
</p>
</div>

<p>
With saving by month is exactly the same as with expenses by month. But we
should query data from hledger by the <code>savings</code> accounts.
</p>
</div>
</div>

<div class="outline-3">
<h3>New budget planning</h3>
<div class="outline-text-3">
<p>
New budget plans via bash-script with <code>dialog</code>:
</p>

<p>
<img src="/assets/static/plan1.png" alt="plan1.png" />
<i>Start date of new budget selection</i>
</p>

<p>
<img src="/assets/static/plan2.png" alt="plan2.png" />
<i>Fields for savings amounts</i>
</p>

<p>
<img src="/assets/static/plan3.png" alt="plan3.png" />
<i>Sum of incoming salary plus remainders from previous budget iteration</i>
</p>

<p>
<img src="/assets/static/plan4.png" alt="plan4.png" />
<i>Budgeting</i>
</p>

<p>
<img src="/assets/static/plan5.png" alt="plan5.png" />
<i>Checking that we haven't gone into the red</i>
</p>

<p>
I realized it simple enough:
</p>
<ul class="org-ul">
<li>Receive necessary data from user via <code>dialog</code> forms — dates, savings amounts,
spending plan for budget.</li>
<li><p>
To avoid having to enter a lot of data, I extract savings amounts from the
previous budget iteration and paste it into the form:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #268bd2;">SAVINGS_DATA</span>=$(hledger -s --value=then,RUB reg -E -O csv <span style="color: #2aa198;">'savings'</span> |
    grep -v <span style="color: #2aa198;">'savings:foreign'</span> |
    awk <span style="color: #2aa198;">'BEGIN {FS=","; OFS=","}</span>
<span style="color: #2aa198;">    {</span>
<span style="color: #2aa198;">        gsub(/"/, "", $0);</span>
<span style="color: #2aa198;">        gsub(" RUB", "", $0);</span>
<span style="color: #2aa198;">        print $2, $5, $6;</span>
<span style="color: #2aa198;">    }'</span> |
    sqlite3 -csv <span style="color: #2aa198;">':memory:'</span> <span style="color: #2aa198;">'.import --csv /dev/stdin savings'</span> <span style="color: #2aa198;">"</span>
<span style="color: #2aa198;">    WITH ordered_savings AS (</span>
<span style="color: #2aa198;">        SELECT date, account, amount FROM savings</span>
<span style="color: #2aa198;">        WHERE date = (SELECT max(date) FROM savings)</span>
<span style="color: #2aa198;">        ORDER BY date, account),</span>
<span style="color: #2aa198;">    savings4gnuplot AS (</span>
<span style="color: #2aa198;">        SELECT date,                                        -- Reversed alphanumeric sorting here:</span>
<span style="color: #2aa198;">            lag(amount, 0) OVER savings_win AS touching,    -- savings:touching</span>
<span style="color: #2aa198;">            lag(amount, 1) OVER savings_win AS investments, -- savings:investments</span>
<span style="color: #2aa198;">            lag(amount, 2) OVER savings_win AS emergency,   -- savings:emergency</span>
<span style="color: #2aa198;">            row_number() OVER savings_win AS rownumber</span>
<span style="color: #2aa198;">        FROM ordered_savings</span>
<span style="color: #2aa198;">        WINDOW savings_win AS(PARTITION BY date)</span>
<span style="color: #2aa198;">        ORDER BY date, account, rownumber),</span>
<span style="color: #2aa198;">    last AS (</span>
<span style="color: #2aa198;">        SELECT date,</span>
<span style="color: #2aa198;">            max(rownumber) AS maxrownumber</span>
<span style="color: #2aa198;">        FROM savings4gnuplot GROUP BY date)</span>
<span style="color: #2aa198;">    SELECT s4g.touching||' '||s4g.emergency||' '||s4g.investments</span>
<span style="color: #2aa198;">    FROM savings4gnuplot AS s4g</span>
<span style="color: #2aa198;">    JOIN last ON s4g.date = last.date AND s4g.rownumber = last.maxrownumber</span>
<span style="color: #2aa198;">    ORDER BY s4g.date;"</span> |
    sed <span style="color: #2aa198;">'s/\"//g'</span>)

<span style="color: #268bd2;">OLDIFS</span>=<span style="color: #2aa198;">"$IFS"</span>
<span style="color: #657b83; font-weight: bold;">read</span> -ra SAVINGS_ARRAY &lt;&lt;&lt; <span style="color: #2aa198;">"$SAVINGS_DATA"</span>
<span style="color: #268bd2;">IFS</span>=<span style="color: #2aa198;">"$OLDIFS"</span>

<span style="color: #268bd2;">SAVINGS</span>=(${<span style="color: #268bd2;">SAVINGS_ARRAY</span>[0]} ${<span style="color: #268bd2;">SAVINGS_ARRAY</span>[1]} ${<span style="color: #268bd2;">SAVINGS_ARRAY</span>[2]} 0 0)
<span style="color: #268bd2;">BUDGET_SAVINGS</span>=($($<span style="color: #268bd2;">DIALOG</span> --form <span style="color: #2aa198;">"Savings information:"</span> 11 43 5 <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #2aa198;">"Touching fund (RUB)"</span> 1 1 <span style="color: #2aa198;">"${SAVINGS[0]}"</span> 1 22 15 10 <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #2aa198;">"Emergency fund (RUB)"</span> 2 1 <span style="color: #2aa198;">"${SAVINGS[1]}"</span> 2 22 15 10 <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #2aa198;">"Investments (RUB)"</span> 3 1 <span style="color: #2aa198;">"${SAVINGS[2]}"</span> 3 22 15 10 <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #2aa198;">"USD"</span> 4 1 <span style="color: #2aa198;">"${SAVINGS[3]}"</span> 4 22 15 10 <span style="color: #b58900; font-weight: bold;">\</span>
    <span style="color: #2aa198;">"EUR"</span> 5 1 <span style="color: #2aa198;">"${SAVINGS[4]}"</span> 5 22 15 10 <span style="color: #b58900; font-weight: bold;">\</span>
    2&gt;&amp;1 1&gt;&amp;3))
</pre>
</div></li>
<li>Simply redirect results, in a form suitable for hledger, to a file
<code>$LEDGER_FILE</code>.</li>
</ul>
<hr />
</div>
</div>
</div>
<div id="footnotes">

<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Technical description here: <a href="https://cbr.ru/development/SXML/">https://cbr.ru/development/SXML/</a>
</p></div></div>


</div>
</div>
